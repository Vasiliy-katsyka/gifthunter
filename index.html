<!DOCTYPE html> 
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CASE HUNTER</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MSDGWEGLR0"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-MSDGWEGLR0');
    </script>
    <style>
        :root {
            --bg-gradient-start: #181A25; --bg-gradient-mid: #202333; --bg-gradient-end: #12141D;
            --surface-color: #282B3D; --surface-hover-color: #31354A;
            --primary-color: #007AFF; --primary-gradient-start: #007AFF; --primary-gradient-end: #34AADC;
            --secondary-color: #FF9500; --text-primary: #F5F5F7; --text-secondary: #AEB4C0;
            --text-placeholder: #7A7F8F; --text-price-color: #C7CDD6;
            --border-color: rgba(120, 120, 128, 0.25); --border-highlight: var(--primary-color);
            --danger-color: #FF3B30; --success-color: #30D158;
            --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --main-border-radius: 16px; --button-border-radius: 12px;
            --soft-shadow: 0px 6px 20px rgba(0, 0, 0, 0.25);
            --case-grad-default: linear-gradient(145deg, var(--surface-color), var(--surface-hover-color));
            --roulette-item-height: 80px; /* Height of a single item in the roulette */
            --roulette-visible-items: 3; /* How many items are roughly visible */
            --single-roulette-row-visual-height: calc(var(--roulette-item-height) * var(--roulette-visible-items) + 20px); /* Total height for one reel to show N items + padding */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { -webkit-overflow-scrolling: touch; }
        body { font-family: var(--font-family); background: linear-gradient(160deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%); color: var(--text-primary); overflow-x: hidden; display: flex; flex-direction: column; min-height: 100vh; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; -webkit-tap-highlight-color: transparent; font-weight: 500; font-size: 15px; line-height: 1.45; }
        #app-container { display: flex; flex-direction: column; flex-grow: 1; }
        #app-header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; background: linear-gradient(to right, rgba(30, 33, 50, 0.88), rgba(40, 43, 60, 0.92)); backdrop-filter: blur(18px) saturate(180%); -webkit-backdrop-filter: blur(18px) saturate(180%); border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 12px rgba(0,0,0,0.2); }
        #app-header .app-title-container { display: flex; align-items: center; gap: 8px; }
        #app-header .app-logo { width: 32px; height: 32px; border-radius: 6px; }
        #app-header .app-title { font-size: 1.5em; font-weight: 700; color: var(--text-primary); letter-spacing: -0.5px; flex-shrink: 0; margin-right: 10px; }
        #app-header .wallet-info { display: flex; align-items: center; gap: 8px; flex-shrink: 1; min-width: 0; }
        #ton-connect-button { display: inline-block; flex-shrink: 0; }
        #wallet-address-display, #balance { background-color: var(--surface-hover-color); padding: 8px 12px; border-radius: var(--button-border-radius); font-size: 0.875em; font-weight: 600; border: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; display: none; transition: background-color 0.2s; }
        #wallet-address-display:hover, #balance:hover { background-color: var(--surface-color); }
        #wallet-address-display.connected, #balance.connected { display: block; }
        #balance.connected { display: flex; align-items: center; }
        #ton-connect-button.connected { display: none; }
        #app-content { flex-grow: 1; padding: 24px 18px; overflow-y: auto; padding-bottom: 80px; }
        .page { display: none; } .page.active { display: block; animation: pageFadeInMinimal 0.3s ease-out; }
        @keyframes pageFadeInMinimal { from { opacity: 0; transform: translateY(8px);} to { opacity: 1; transform: translateY(0px);} }
        #app-nav { display: flex; justify-content: space-around; align-items: stretch; background-color: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border-top: 1px solid var(--border-color); padding: 0; position: sticky; bottom: 0; z-index: 1000; min-height: 65px; box-shadow: 0 -3px 15px rgba(0,0,0,0.15); }
        .nav-button { background: none; border: none; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; font-weight: 500; cursor: pointer; padding: 8px 5px; border-radius: 0; transition: color 0.2s, background-color 0.2s, transform 0.1s ease-out; flex: 1; text-align: center; line-height: 1.3; }
        .nav-button:hover { background-color: rgba(255,255,255,0.05); } .nav-button:active { transform: scale(0.96); }
        .nav-button.active { color: var(--primary-color); font-weight: 600; }
        .nav-button svg { width: 28px; height: 28px; margin-bottom: 4px; fill: currentColor; }
        .nav-button.active svg { fill: var(--primary-color); }
        .button { background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end)); color: var(--text-primary); border: none; padding: 14px 24px; border-radius: var(--button-border-radius); font-size: 1.0em; font-weight: 600; cursor: pointer; transition: filter 0.2s ease-out, transform 0.15s ease-out, box-shadow 0.2s ease-out; text-align: center; display: block; width: 100%; box-shadow: 0 3px 8px rgba(0,122,255,0.25); }
        .button:hover { filter: brightness(1.15); box-shadow: 0 4px 12px rgba(0,122,255,0.3); }
        .button:active { transform: scale(0.97); filter: brightness(0.9); box-shadow: 0 2px 5px rgba(0,122,255,0.2); }
        .button:disabled { background: var(--surface-hover-color); color: var(--text-placeholder); cursor: not-allowed; box-shadow: none; filter: grayscale(0.5); }
        .button-secondary { background-color: var(--surface-hover-color); color: var(--text-secondary); border: 1px solid var(--border-color); box-shadow: none; background-image: none; }
        .button-secondary:hover { background-color: var(--surface-color); color: var(--text-primary); border-color: rgba(120,120,128,0.5); }
        .button-secondary:active { background-color: var(--surface-hover-color); filter: brightness(0.9); }
        .button-secondary:disabled { background: var(--surface-color); color: var(--text-placeholder); border-color: var(--border-color); cursor: not-allowed; filter: grayscale(0.3); }
        h2 { margin-top: 0; font-size: 2.0em; font-weight: 700; color: var(--text-primary); padding-bottom: 10px; margin-bottom: 28px; letter-spacing: -0.5px; }
        h3 { font-size: 1.15em; font-weight: 600; color: var(--text-secondary); margin-top: 24px; margin-bottom: 14px; text-transform: uppercase; letter-spacing: 0.8px; }
        .content-card { background-color: var(--surface-color); padding: 20px; border-radius: var(--main-border-radius); margin-bottom: 20px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .cases-grid, .slots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(max(150px, calc(50% - 10px - 1px)), 1fr)); gap: 20px; }
        
        .case-card { background-image: var(--case-grad-default); border-radius: var(--main-border-radius); text-align: center; cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--border-color); overflow: hidden; position: relative; display: flex; flex-direction: column; padding: 0; justify-content: space-between; }
        .case-card:hover { filter: brightness(1.12); transform: translateY(-6px) scale(1.02); box-shadow: var(--soft-shadow); }
        .case-image-display { width: 100%; height: 0; padding-bottom: 100%; position: relative; background-color: var(--surface-hover-color); display:flex; align-items:center; justify-content:center; }
        .case-image-display img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: block; }
        .case-image-display .overlay-image { position: absolute; width: 70%; height: 70%; top: 50%; left: 50%; transform: translate(-50%, -50%); object-fit: contain; pointer-events: none; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.35)); }
        .case-name { font-weight: 600; font-size: 1.05em; margin-bottom: 8px; color: var(--text-primary); min-height: 2.5em; display: flex; align-items: center; justify-content: center; }
        .case-card .case-name { display: none !important; }
        .case-price { font-size: 0.95em; font-weight: 600; color: var(--text-primary); padding: 12px 0; background-color: rgba(0,0,0,0.2); width: 100%; border-top: 1px solid var(--border-color); }
        
        .slot-card { background-image: var(--case-grad-default); border-radius: var(--main-border-radius); padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--border-color); overflow: hidden; position: relative; }
        .slot-card:hover { filter: brightness(1.12); transform: translateY(-6px) scale(1.02); box-shadow: var(--soft-shadow); }
        .slot-image-display { width: 85px; height: 85px; margin: 0 auto 18px auto; background-color: transparent; border-radius: var(--button-border-radius); overflow: hidden; position: relative; display:flex; align-items:center; justify-content:center;}
        .slot-image-display img { display: block; width: 100%; height: 100%; object-fit: contain; }
        .slot-name { font-weight: 600; font-size: 1.05em; margin-bottom: 8px; color: var(--text-primary); min-height: 2.5em; display: flex; align-items: center; justify-content: center; }
        .slot-price { font-size: 0.9em; font-weight: 500; color: var(--text-price-color); }
        #profile-balance-display { font-size: 1.6em; font-weight: 600; color: var(--primary-color); margin-bottom: 20px; }
        
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(10, 10, 20, 0.75); backdrop-filter: blur(12px) saturate(150%); -webkit-backdrop-filter: blur(12px) saturate(150%); overflow-y: auto; align-items: flex-start; justify-content: center; padding-top: 5vh; padding-bottom: 5vh; }
        .modal.active { display: flex; animation: modalFadeInMinimal 0.3s ease-out; }
        .modal-content { background-color: var(--surface-color); padding: 28px; border-radius: var(--main-border-radius); width: 100%; max-width: 420px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.4); border: 1px solid var(--border-color); display: flex; flex-direction: column; margin: auto; position: relative; }
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; font-size: 1.4em; font-weight: 700; color: var(--text-primary); flex-shrink: 0; }
        .modal-actions { margin-bottom: 18px; display: flex; flex-direction: column; gap: 14px; flex-shrink: 0; }
        .modal-body { overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; margin-top: 12px; max-height: 60vh; }
        
        #roulette-wheel-container { width: 100%; flex-shrink: 0; height: var(--single-roulette-row-visual-height); display: flex; gap: 8px; align-items: center; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--main-border-radius); overflow: hidden; position: relative; padding: 10px; }
        .roulette-individual-reel-row-visual { flex: 1; height: 100%; overflow: hidden; position: relative; background-color: var(--surface-hover-color); border-radius: var(--button-border-radius); border: 1px solid rgba(255,255,255,0.05); display: none; }
        .roulette-individual-reel-row-visual.active { display: block; }
        .roulette-individual-reel-row-visual::before { content: ''; position: absolute; left: 0; right: 0; top: 50%; height: 3px; background-color: var(--primary-color); opacity: 0.9; transform: translateY(-50%); z-index: 2; pointer-events: none; border-radius: 2px; }
        .roulette-spinner-reel { display: flex; flex-direction: column; position: absolute; left: 0; width: 100%; top: 0; }
        .roulette-item { height: var(--roulette-item-height); display: flex; align-items: center; justify-content: center; padding: 0 5px; box-sizing: border-box; overflow: hidden; transition: opacity 0.3s; }
        .roulette-item img { max-width: 90%; max-height: calc(var(--roulette-item-height) - 10px); object-fit: contain; }
        .case-multiplier-selector { display: flex; justify-content: center; gap: 10px; margin-top: 25px; margin-bottom: 15px; }
        .case-multiplier-selector button { width: auto; flex-grow: 1; padding: 10px 15px; font-size: 0.9em; }
        
        #win-overlay-modal .modal-content, #upgrade-result-modal .modal-content { max-width: 360px; }
        #win-overlay-prize-image, #upgrade-result-image-container { width: 100%; min-height: 80px; margin: 0 auto 20px; border-radius: var(--main-border-radius); background-color: var(--surface-hover-color); display:flex; align-items:center; justify-content:center; overflow:hidden; flex-wrap: wrap; gap: 10px; padding: 10px; }
        #win-overlay-prize-image img, #upgrade-result-image-container img { max-width:70px; max-height:70px; object-fit:contain; border-radius: 8px; background-color: var(--surface-color); padding: 5px; border: 1px solid var(--border-color); }
        #win-overlay-prize-name, #upgrade-result-title { font-size: 1.5em; font-weight: 700; margin-bottom: 8px; }
        #win-overlay-prize-name { color: var(--success-color); } /* Only for win overlay */
        #win-overlay-prize-details, #upgrade-result-message { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 25px; max-height: 60px; overflow-y: auto; text-align: left; padding-left: 10px;}
        .win-overlay-actions button { margin-bottom: 10px; }
        
        #possible-prizes-display { padding-right: 0px; display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; flex-shrink: 0; margin-top: 12px; }
        .prize-card { background-color: var(--surface-hover-color); border-radius: var(--button-border-radius); padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border: 1px solid var(--border-color); text-align: center; min-height: 110px; }
        .prize-card-image-placeholder { width: 55px; height: 55px; background-color: transparent; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .prize-card-image-placeholder img { display: block; width: 100%; height: 100%; object-fit: contain; position: relative; z-index: 1; }
        .prize-card-name { font-size: 0.8em; font-weight: 500; color: var(--text-secondary); line-height: 1.25; width: 100%; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; white-space: normal; }
        .prize-card-price { position: absolute; top: 5px; right: 5px; background-color: var(--primary-color); color: var(--text-primary); font-size: 0.7em; font-weight: 600; padding: 2px 5px; border-radius: 5px; line-height: 1; }
        #roulette-modal hr { border: none; border-top: 1px solid var(--border-color); margin: 18px 0; flex-shrink: 0; }
        #roulette-modal h4 { font-size: 0.95em; color: var(--text-secondary); margin-bottom: 12px; font-weight: 500; flex-shrink: 0; }
        
        #slot-machine-modal .modal-content { max-width: 480px; }
        /* ... (existing slot styles, keep if slots feature is still there) ... */
        
        #withdraw-modal .modal-step { display: none; } #withdraw-modal .modal-step.active { display: block; } #withdraw-modal p { color: var(--text-secondary); margin-bottom: 18px; line-height: 1.55;} #withdraw-modal strong { color: var(--text-primary); font-weight: 600; } #withdraw-modal a.button { margin-bottom: 12px; text-decoration: none; }
        .loader { border: 4px solid var(--surface-hover-color); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin: 22px auto; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type="text"], input[type="number"], select { width: 100%; padding: 13px 15px; margin-bottom: 14px; border-radius: var(--button-border-radius); background-color: var(--surface-hover-color); color: var(--text-primary); border: 1px solid var(--border-color); font-size: 1em; font-weight: 500; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; } input[type="text"]::placeholder, input[type="number"]::placeholder { color: var(--text-placeholder); } input[type="text"]:focus, input[type="number"]:focus, select:focus { outline: none; border-color: var(--border-highlight); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.25); }
        .profile-header { text-align: center; margin-bottom: 28px; padding-top: 12px;} .profile-avatar-placeholder { width: 88px; height: 88px; border-radius: 50%; background-color: var(--surface-hover-color); display: flex; align-items: center; justify-content: center; font-size: 2.8em; font-weight: 600; color: var(--text-secondary); margin: 0 auto 14px auto; border: 3px solid var(--border-color); box-shadow: 0 2px 6px rgba(0,0,0,0.1); } .profile-info .username { font-size: 1.5em; font-weight: 600; margin-bottom: 5px;} .profile-info .userid { font-size: 0.9em; color: var(--text-secondary); }
        #profile-wallet-address { display: block; text-align: left; word-break: break-all; margin-bottom: 10px; }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(115px, 1fr)); gap: 12px; } .inventory-item { background-color: var(--surface-hover-color); border-radius: var(--button-border-radius); padding: 12px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid var(--border-color); transition: transform 0.2s, box-shadow 0.2s; } .inventory-item:hover { transform: translateY(-3px); box-shadow: 0 3px 10px rgba(0,0,0,0.15); } .inventory-item .item-image-display { width: 65px; height: 65px; margin: 0 auto 10px auto; background-color: transparent; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; position:relative; } .inventory-item .item-image-display img { display: block; width: 100%; height: 100%; object-fit: contain; position:relative; z-index: 1;}
        .inventory-item-name { font-size: 0.88em; font-weight: 500; margin-bottom: 5px; line-height: 1.35; } .inventory-item-value { font-size: 0.78em; color: var(--secondary-color); font-weight: 500; margin-bottom: 10px;} .inventory-item-actions { display: flex; flex-direction: column; gap: 6px; margin-top: auto; } .inventory-item-actions .button { font-size: 0.78em; padding: 6px 9px; margin: 0; width: 100%; }
        #sell-all-button { margin-top: 18px; background-color: var(--danger-color); color: white; background-image: none; box-shadow: 0 3px 8px rgba(255, 59, 48, 0.35); } #sell-all-button:hover { filter: brightness(1.15); background-color: var(--danger-color); box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4); } #sell-all-button:active { filter: brightness(0.9); transform: scale(0.97); }
        
        /* --- NEW/UPDATED UPGRADE PAGE STYLES --- */
        #upgrade-selection-area {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 25px;
            gap: 10px; /* Gap between slots and arrow */
        }
        
        .upgrade-item-slot {
            flex: 1; /* Each slot takes equal width */
            max-width: calc(50% - 25px); /* Max width considering arrow and gap */
            height: 150px; /* Fixed height for the square */
            background-color: var(--surface-hover-color);
            border-radius: var(--main-border-radius);
            border: 2px dashed var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: border-color 0.2s, background-color 0.2s;
            padding: 10px;
            text-align: center;
        }
        .upgrade-item-slot:hover {
            border-color: var(--primary-color);
            background-color: var(--surface-color);
        }
        .upgrade-item-slot .slot-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-placeholder);
        }
        .upgrade-item-slot .slot-placeholder .plus-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 8px;
            fill: var(--text-placeholder);
        }
        .upgrade-item-slot .slot-placeholder span {
            font-size: 0.9em;
            font-weight: 500;
        }
        .upgrade-item-slot .slot-item-display img {
            width: 60px; /* Adjust size as needed */
            height: 60px;
            object-fit: contain;
            margin-bottom: 8px;
            border-radius: 8px;
        }
        .upgrade-item-slot .slot-item-display .slot-item-name {
            font-size: 0.85em;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.2;
            margin-bottom: 4px;
            max-height: 2.4em; /* Approx 2 lines */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .upgrade-item-slot .slot-item-display .slot-item-value {
            font-size: 0.75em;
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .upgrade-arrow-connector {
            width: 30px; /* Width of the arrow */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .upgrade-arrow-connector svg {
            width: 28px;
            height: 28px;
            fill: var(--text-secondary);
        }
        
        #upgrade-picker-container {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(0,0,0,0.1);
            border-radius: var(--button-border-radius);
        }
        #upgrade-picker-container h4 {
            color: var(--text-primary);
            font-size: 1.1em;
            margin-bottom: 15px;
            text-align: center;
        }
        /* Ensure inventory-grid within picker has proper styling */
        #upgrade-items-grid {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* Adjust minmax for smaller cards */
            gap: 10px; /* Smaller gap */
            padding-right: 5px; /* For scrollbar space */
        }
        #upgrade-items-grid .inventory-item {
            padding: 10px; /* Smaller padding */
            min-height: 130px; /* Adjust height */
        }
        #upgrade-items-grid .inventory-item .item-image-display {
            width: 50px; height: 50px; margin-bottom: 8px;
        }
        #upgrade-items-grid .inventory-item .inventory-item-name { font-size: 0.8em; }
        #upgrade-items-grid .inventory-item .inventory-item-value { font-size: 0.7em; margin-bottom: 8px; }
        #upgrade-items-grid .inventory-item .button { font-size: 0.75em; padding: 5px 8px;}
        
        
        #upgrade-chance-display-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 30px auto; /* Increased margin for better spacing */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #upgrade-chance-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 8px solid var(--surface-hover-color); /* Default/Losing segment color */
            position: relative;
            /* Winning segment will be an overlay or conic-gradient if browser support is fine */
            background: conic-gradient(
                var(--success-color) 0deg var(--upgrade-win-segment-angle, 0deg), 
                var(--danger-color) var(--upgrade-win-segment-angle, 0deg) 360deg
            );
            box-shadow: 0 0 20px rgba(0,0,0,0.2), inset 0 0 15px rgba(0,0,0,0.3);
            transition: transform 0.3s ease-out; /* For subtle effects if needed */
        }
        
        #upgrade-chance-pointer {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 18px solid var(--primary-color); /* Triangle color */
            position: absolute;
            top: -2px; /* Position slightly above the circle's border */
            left: 50%;
            transform: translateX(-50%) rotate(0deg); /* Initial position at the top */
            transform-origin: center calc(75px + 9px); /* (radius + half of triangle height approx offset from center) */
            z-index: 2;
            filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.4));
        }
        #upgrade-chance-pointer.spinning {
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        
        #upgrade-chance-text-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-primary);
            background-color: rgba(40, 43, 61, 0.85); /* Slightly transparent background for text */
            width: calc(100% - 32px); /* Inner circle for text, considering border width */
            height: calc(100% - 32px);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        #upgrade-calculated-multiplier {
            font-size: 2.2em;
            font-weight: 800;
            line-height: 1.1;
            color: var(--primary-gradient-end);
            display: block;
        }
        #upgrade-calculated-chance {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-secondary);
            display: block;
        }
        
        /* Old multiplier buttons removed from default view if any */
        #multiplier-buttons { display: none; } 
        #upgrade-inventory-select { display: none; }
        #upgrade-page .content-card p:first-of-type { display: none; } /* Hide "Select an item:" */
        #upgrade-page .content-card #upgrade-result { display: none; } /* Hide old result text */
        
        /* END UPGRADE PAGE STYLES */
        
        .stats-box { display: flex; justify-content: space-around; margin: 24px 0; gap: 14px; } .stat-item { background-color: var(--surface-hover-color); padding: 14px; border-radius: var(--button-border-radius); flex: 1; text-align: center; border: 1px solid var(--border-color); } .stat-item .value { font-size: 1.6em; font-weight: 600; color: var(--primary-color); } .stat-item .label { font-size: 0.8em; color: var(--text-secondary); margin-top: 5px; } .invited-users-list div { padding: 10px 0; border-bottom: 1px solid var(--border-color); font-size: 0.9em;} .invited-users-list div:last-child { border-bottom: none; }
        .leaderboard-list { padding-left: 0; padding-right: 0; } .leaderboard-list .leader-entry { display: flex; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border-color); transition: background-color 0.25s ease-out; position: relative; } .leaderboard-list .leader-entry:hover { background-color: rgba(255,255,255,0.04); } .leaderboard-list .leader-entry:last-child { border-bottom: none; } .leader-entry .rank { font-weight: 700; font-size: 1.05em; min-width: 40px; text-align: left; color: var(--text-secondary); margin-right: 15px; } .leader-entry .avatar-placeholder { width: 44px; height: 44px; border-radius: 50%; background-color: var(--surface-hover-color); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; font-size: 1.2em; font-weight: 600; margin: 0 16px 0 0; border: 2px solid var(--border-color); } .leader-entry .info { flex-grow: 1; } .leader-entry .info .name { font-weight: 600; font-size: 1.1em; color: var(--text-primary); margin-bottom: 3px; } .leader-entry .info .details { font-size: 0.85em; color: var(--text-secondary); line-height: 1.3; } .leader-entry .score { margin-left: auto; font-weight: 700; font-size: 1.05em; color: var(--primary-color); padding-left: 15px; text-align: right; } .leader-entry.current-user-entry { background-color: rgba(0, 122, 255, 0.12); border-left: 3px solid var(--primary-color); padding-left: 17px;} .leader-entry.current-user-entry .rank { color: var(--primary-color); } .leader-entry.current-user-entry .info .name { color: var(--primary-gradient-end); font-weight: 700; } .leader-entry.current-user-entry .score { color: var(--secondary-color); font-weight: 800; } .leader-entry.current-user-entry .avatar-placeholder { border-color: var(--primary-color); }
        #deposit-instructions-modal .modal-body p { color: var(--text-secondary); font-size: 0.95em; line-height: 1.6; margin-bottom: 18px; } #deposit-instructions-modal .modal-body strong { color: var(--text-primary); font-weight: 600; } #deposit-instructions-modal #ton-transfer-link { margin-top: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 8px; } #deposit-instructions-modal #ton-transfer-link svg { width: 20px; height: 20px; fill: currentColor; } #deposit-status-message, #deposit-expiry-info { text-align: center; }
        .promocode-input-group { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; } .promocode-input-group input { flex-grow: 1; margin-bottom: 0; } .promocode-input-group button { flex-shrink: 0; padding: 13px 18px; width: auto; }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(160deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: var(--text-primary); font-family: var(--font-family); transition: opacity 0.5s ease-out, visibility 0.5s ease-out; }
        #loading-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .loading-logo { width: 80px; height: 80px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .loading-title { font-size: 2.8em; font-weight: 800; margin-bottom: 30px; letter-spacing: -1px; background: linear-gradient(45deg, var(--primary-color), var(--primary-gradient-end)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 2px 8px rgba(0,122,255,0.2); }
        #loading-screen .loader { width: 60px; height: 60px; margin-top: 20px; margin-bottom: 30px; border-width: 6px; box-shadow: 0 0 15px rgba(0,122,255,0.2); }
        .loading-status-text { font-size: 1.1em; font-weight: 500; color: var(--text-secondary); margin-bottom: 40px; }
        .channel-link-container { position: absolute; bottom: 30px; width: 100%; text-align: center; }
        .channel-link-container a { color: var(--primary-color); text-decoration: none; font-weight: 600; font-size: 1.1em; padding: 8px 15px; border-radius: 8px; background-color: rgba(0,122,255,0.1); transition: background-color 0.2s, color 0.2s; }
        .channel-link-container a:hover { background-color: rgba(0,122,255,0.2); color: var(--text-primary); }
        .balance-icon {
            width: 20px;
            height: 20px;
            margin-right: 6px;
            vertical-align: middle;
        }
        .case-name-container {
            padding: 12px 10px;
            min-height: 50px; /* Ensure space for the name */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .case-name {
            font-weight: 600;
            font-size: 1.05em;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .emoji-as-image {
            font-size: 48px; /* Adjust size to match your images */
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        #roulette-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px; /* Space between header and roulette wheel */
        }
    
        #roulette-modal .modal-header h3 {
            margin-bottom: 0; /* Remove default margin from h3 */
            padding-bottom: 0;
            text-align: left;
            flex-grow: 1; /* Allow title to take available space */
        }
    
        /* New styles for the balance display to match the image */
        #roulette-modal-balance-display {
            text-align: right;
            line-height: 1.25;
            flex-shrink: 0; /* Prevent balance from shrinking */
            margin-left: 15px; /* Space between title and balance */
        }
    
        #roulette-modal-balance-display .balance-label {
            font-size: 0.8em;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }
    
        #roulette-modal-balance-display .balance-value-line {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
            font-size: 1.25em;
            font-weight: 600;
            color: var(--text-primary);
        }
    
        #roulette-modal-balance-display .balance-value-line .balance-icon {
            width: 20px;
            height: 20px;
        }

        /* Add these styles to your main <style> block */
        
        .banner-carousel {
            position: relative;
            width: 100%;
            margin-bottom: 28px;
            overflow: hidden;
            border-radius: var(--main-border-radius);
            box-shadow: var(--soft-shadow);
            /* Ensures touch events are smooth on iOS */
            -webkit-transform: translate3d(0, 0, 0);
        }
        
        .banner-slides {
            display: flex;
            transition: transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .banner-slide {
            flex-shrink: 0;
            width: 100%;
            position: relative;
        }
        
        .banner-slide a, .banner-slide img {
            display: block;
            width: 100%;
            height: auto; /* Maintain aspect ratio of the image */
            border-radius: var(--main-border-radius);
        }
        
        .banner-pagination {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        
        .banner-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }
        
        .banner-dot.active {
            background-color: rgba(255, 255, 255, 0.9);
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <img src="https://github.com/Vasiliy-katsyka/gifthunter/blob/main/black%20(3).png?raw=true" alt="Pusik Gifts Logo" class="loading-logo">
        <div class="loading-title">CASE HUNTER</div>
        <div class="loader"></div>
        <p id="loading-status" class="loading-status-text">Loading...</p>
        <div class="channel-link-container">
            <a href="https://t.me/nft" target="_blank">@casehunter</a>
        </div>
    </div>
    <div id="app-container">
        <header id="app-header">
            <div class="app-title-container"><img src="https://github.com/Vasiliy-katsyka/gifthunter/blob/main/black%20(3).png?raw=true" alt="Pusik Gifts Logo" class="app-logo"><div class="app-title">Case Hunter</div></div>
            <div class="wallet-info">
                <div id="wallet-address-display">Connected: ...</div>
                <div id="balance">
                    <img src="https://raw.githubusercontent.com/Vasiliy-katsyka/gifthunter/refs/heads/main/DMJTGStarsEmoji_AgADZxIAAjoUmVI.png" alt="Star" class="balance-icon">
                    <span id="star-balance">0</span>
                </div>
                <div id="ton-connect-button"></div>
            </div>
        </header>

        <main id="app-content">
            <div id="main-page" class="page active">
                <div id="banner-carousel" class="banner-carousel">
                    <div class="banner-slides">
                        <!-- Banner slides will be injected here by JavaScript -->
                    </div>
                    <div class="banner-pagination">
                        <!-- Pagination dots will be injected here by JavaScript -->
                    </div>
                </div>
                <h2>Cases</h2>
                <div id="cases-grid" class="cases-grid"></div>
                <!-- Removed slots section for brevity, can be re-added if needed -->
            </div>

            <!-- UPGRADE PAGE - MODIFIED STRUCTURE -->
            <div id="upgrade-page" class="page">
                <h2>Upgrade Item</h2>
                <div class="content-card">
                    <div id="upgrade-selection-area">
                        <div class="upgrade-item-slot" id="selected-inventory-item-slot" data-type="inventory">
                            <div class="slot-placeholder">
                                <svg class="plus-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg>
                                <span>Your Item</span>
                            </div>
                            <div class="slot-item-display" style="display: none;">
                                <img src="" alt="Selected Item">
                                <p class="slot-item-name">Item Name</p>
                                <p class="slot-item-value">0.00 TON</p>
                            </div>
                        </div>
                        <div class="upgrade-arrow-connector">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4,15V9H12V4.16L19.84,12L12,19.84V15H4Z" /></svg>
                        </div>
                        <div class="upgrade-item-slot" id="desired-upgrade-item-slot" data-type="desired">
                            <div class="slot-placeholder">
                                <svg class="plus-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg>
                                <span>Desired Item</span>
                            </div>
                            <div class="slot-item-display" style="display: none;">
                                <img src="" alt="Desired Item">
                                <p class="slot-item-name">Item Name</p>
                                <p class="slot-item-value">0.00 TON</p>
                            </div>
                        </div>
                    </div>

                    <div id="upgrade-picker-container" style="display: none;">
                        <h4 id="upgrade-picker-title">Select Your Item</h4>
                        <div id="upgrade-items-grid" class="inventory-grid" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;">
                            <!-- Items will be populated here by JS -->
                        </div>
                        <button id="close-upgrade-picker-button" class="button button-secondary">Close Picker</button>
                    </div>
                    
                    <div id="upgrade-chance-display-container">
                        <div id="upgrade-chance-circle">
                            <div id="upgrade-chance-pointer"></div>
                        </div>
                        <div id="upgrade-chance-text-overlay">
                            <span id="upgrade-calculated-multiplier">--x</span>
                            <span id="upgrade-calculated-chance">--%</span>
                        </div>
                    </div>
                    
                    <button id="do-upgrade-button" class="button" disabled>Select Items to Upgrade</button>
                </div>
            </div>
            <!-- END UPGRADE PAGE -->

            <div id="invite-page" class="page"><h2>Referrals</h2><div class="content-card"><p>Invite friends & earn <strong>5 stars</strong> per friend + <strong>10%</strong> of their deposits!</p><input type="text" id="referral-link" value="Loading..." readonly><button id="copy-ref-link-button" class="button">Copy Code</button><div class="stats-box"><div class="stat-item"><div id="referral-balance" class="value">0.00 TON</div><div class="label">Earnings</div></div><div class="stat-item"><div id="invited-count" class="value">0</div><div class="label">Invited</div></div></div><button id="withdraw-referral-button" class="button button-secondary">Вывести на баланс</button></div><div class="content-card"><h3>Invited Friends</h3><div id="invited-users-list-display" class="invited-users-list"><p>No friends invited yet.</p></div></div></div>
            <div id="leaderboard-page" class="page"><h2>Leaderboard</h2><div id="leaderboard-list" class="leaderboard-list content-card" style="padding-top:0; padding-bottom:0;"></div></div>
            <div id="profile-page" class="page">
                <div class="profile-header">
                    <div id="profile-avatar" class="profile-avatar-placeholder"></div>
                    <div class="profile-info">
                        <div id="profile-username" class="username">User</div>
                        <div id="profile-userid" class="userid">#...</div>
                    </div>
                </div>
            
                <div class="content-card">
                    <h3>Balance</h3>
                    <div id="profile-balance-display" style="display: flex; align-items: center; justify-content: center;">
                        <img src="https://raw.githubusercontent.com/Vasiliy-katsyka/gifthunter/refs/heads/main/DMJTGStarsEmoji_AgADZxIAAjoUmVI.png" alt="Star" class="balance-icon" style="width: 28px; height: 28px; margin-right: 8px;">
                        <span>0</span>
                    </div>
                    <input type="number" id="deposit-amount-input" placeholder="Amount (Min 50 stars)">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button id="initiate-deposit-stars-button" class="button">Депозит Stars</button>
                        <button id="initiate-deposit-ton-button" class="button button-secondary">Депозит TON</button>
                    </div>
                </div>
            
                <div class="content-card">
                    <h3>Promocode</h3>
                    <div class="promocode-input-group">
                        <input type="text" id="promocode-input" placeholder="Enter code">
                        <button id="redeem-promocode-button" class="button button-secondary">Redeem</button>
                    </div>
                </div>

                <div class="content-card">
                    <h3>Support</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9em;">
                        Have questions or need help? Contact our support team on Telegram.
                    </p>
                    <button id="support-button" class="button">Contact Support</button>
                </div>
                
                <div class="content-card">
                    <h3>Wallet</h3>
                    <div id="profile-wallet-address">Not Connected</div>
                    <button id="disconnect-wallet-button" class="button button-secondary" style="display: none;">Disconnect</button>
                </div>
            
                <div class="content-card">
                    <h3>My Collection (<span id="inventory-count">0</span>)</h3>
                    <div id="inventory-grid" class="inventory-grid">
                        <p id="empty-inventory-message" style="grid-column: 1 / -1; text-align: center; color: var(--text-placeholder); padding:15px 0;">Your collection is empty.</p>
                    </div>
                    <button id="sell-all-button" class="button" style="display: none;">Sell All for <span id="sell-all-value">0</span> <img src="https://raw.githubusercontent.com/Vasiliy-katsyka/gifthunter/refs/heads/main/DMJTGStarsEmoji_AgADZxIAAjoUmVI.png" alt="Star" class="balance-icon" style="width: 16px; height: 16px;"></button>
                </div>
            </div>    
        </main>

        <nav id="app-nav">
            <button class="nav-button active" data-page="main-page"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Games</button>
            <button class="nav-button" data-page="upgrade-page">
                <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1">
                  <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
                  <path d="M7.41 11.41L12 6.83l4.59 4.58L18 10l-6-6-6 6z"/>
                  <path d="M7.41 7.41L12 2.83l4.59 4.58L18 6l-6-6-6 6z"/>
                </svg>Upgrade
            </button>
            <button class="nav-button" data-page="invite-page"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>Referrals</button>
            <button class="nav-button" data-page="leaderboard-page"><svg viewBox="0 0 24 24"><path d="M16,1H4C2.89,1 2,1.89 2,3V17H4V3H16V1M16.5,5H7.5C6.67,5 6,5.67 6,6.5V22.5L12,19.5L18,22.5V6.5C18,5.67 17.33,5 16.5,5M14,11H10V9H14V11M14,15H10V13H14V15Z"/></svg>Leaders</button>
            <button class="nav-button" data-page="profile-page"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>Profile</button>
        </nav>
    </div>

    <div id="roulette-modal" class="modal">
        <div class="modal-content">
            <!-- MOVED AND RESTRUCTURED: Balance Display -->
            <div class="modal-header">
                <h3 id="roulette-case-name">Opening Case...</h3>
                <div id="roulette-modal-balance-display">
                    <div class="balance-label">Balance</div>
                    <div class="balance-value-line">
                        <span id="roulette-modal-balance-value">0</span>
                        <img src="https://raw.githubusercontent.com/Vasiliy-katsyka/gifthunter/refs/heads/main/DMJTGStarsEmoji_AgADZxIAAjoUmVI.png" alt="Star" class="balance-icon">
                    </div>
                </div>
            </div>
    
            <div id="roulette-wheel-container">
                <div class="roulette-individual-reel-row-visual" id="roulette-reel-1">
                    <div class="roulette-spinner-reel"></div>
                </div>
                <div class="roulette-individual-reel-row-visual" id="roulette-reel-2">
                    <div class="roulette-spinner-reel"></div>
                </div>
                <div class="roulette-individual-reel-row-visual" id="roulette-reel-3">
                    <div class="roulette-spinner-reel"></div>
                </div>
            </div>
    
            <!-- The old balance display from here has been removed -->
    
            <div class="case-multiplier-selector">
                <button class="button button-secondary active-multiplier" data-multiplier="1">1x</button>
                <button class="button button-secondary" data-multiplier="2">2x</button>
                <button class="button button-secondary" data-multiplier="3">3x</button>
            </div>
            <div class="modal-actions">
                <button id="spin-button" class="button">Spin</button>
                <button id="close-roulette-button" class="button button-secondary">Close</button>
            </div>
            <hr><h4>Possible Prizes in this Case:</h4><div id="possible-prizes-display"></div>
        </div>
    </div>

    <div id="win-overlay-modal" class="modal">
        <div class="modal-content">
            <div id="win-overlay-prize-image"></div>
            <div id="win-overlay-prize-name">You Won: Item!</div>
            <div id="win-overlay-prize-details"></div>
            <div class="win-overlay-actions modal-actions">
                <button id="win-overlay-save-button" class="button">Save to Collection</button>
                <!-- CORRECTED: Removed hardcoded "TON" -->
                <button id="win-overlay-convert-button" class="button button-secondary">Convert All for <span id="win-overlay-convert-value">0</span> <img src="https://raw.githubusercontent.com/Vasiliy-katsyka/gifthunter/refs/heads/main/DMJTGStarsEmoji_AgADZxIAAjoUmVI.png" alt="Star" class="balance-icon" style="width: 16px; height: 16px;"></button>
            </div>
        </div>
    </div>
    
    <!-- NEW UPGRADE RESULT MODAL -->
    <div id="upgrade-result-modal" class="modal">
        <div class="modal-content">
            <div id="upgrade-result-image-container">
                <!-- Image of item won/lost -->
            </div>
            <h3 id="upgrade-result-title">Upgrade Status</h3>
            <p id="upgrade-result-message">Details about the upgrade...</p>
            <div class="modal-actions">
                <button id="close-upgrade-result-modal-button" class="button">OK</button>
            </div>
        </div>
    </div>
    <!-- END UPGRADE RESULT MODAL -->


    <div id="withdraw-modal" class="modal">
        <div class="modal-content">
            <h3>Withdraw Gift</h3>
            <div class="modal-body">
                <p>Are you sure you want to request a withdrawal for <strong id="withdraw-item-name"></strong>? An administrator will process your request shortly.</p>
            </div>
            <div class="modal-actions">
                <button id="confirm-withdraw-button" class="button">Confirm</button>
                <button id="close-withdraw-modal-button" class="button button-secondary">Cancel</button>
            </div>
        </div>
    </div>
    
    
    <!-- In index.html, replace the entire #deposit-instructions-modal div -->
    <div id="deposit-instructions-modal" class="modal">
        <div class="modal-content">
            <h3>Deposit TON</h3>
            <div class="modal-body" style="text-align: left;">
                <p>To deposit, send the <strong>exact amount</strong> of TON to the address below. You <strong>MUST</strong> include the unique comment provided.</p>
                
                <div class="content-card" style="margin-bottom: 15px; padding: 15px;">
                    <h4 style="margin-top:0; margin-bottom: 8px; color: var(--text-secondary);">Wallet Address:</h4>
                    <p id="deposit-wallet-address" style="word-break: break-all; font-weight: 600; margin-bottom: 10px;"></p>
                    <button id="copy-deposit-address-button" class="button button-secondary">Copy Address</button>
                </div>
    
                <div class="content-card" style="margin-bottom: 20px; padding: 15px;">
                    <h4 style="margin-top:0; margin-bottom: 8px; color: var(--text-secondary);">Required Comment:</h4>
                    <p id="deposit-comment-text" style="font-weight: 600; margin-bottom: 10px; font-size: 1.2em; letter-spacing: 1px;"></p>
                    <button id="copy-deposit-comment-button" class="button button-secondary">Copy Comment</button>
                </div>
    
                <a id="ton-transfer-link" href="#" target="_blank" class="button">
                    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,4.5A7.5,7.5,0,0,1,19.5,12A7.5,7.5,0,0,1,12,19.5A7.5,7.5,0,0,1,4.5,12A7.5,7.5,0,0,1,12,4.5M12,2A10,10,0,0,0,2,12A10,10,0,0,0,12,22A10,10,0,0,0,22,12A10,10,0,0,0,12,2M11,17H13V15H11V17M13,13H11V7H13V13Z"/></svg>
                    Open Wallet & Pay
                </a>
                <p id="deposit-expiry-info" style="text-align: center; margin-top: 15px;"></p>
                <p id="deposit-status-message" style="text-align: center;"></p>
                <div id="deposit-loader" class="loader" style="display:none;"></div>
                <button id="confirm-payment-sent-button" class="button button-secondary">I Sent Funds</button>
                <button id="cancel-deposit-button" class="button button-secondary">Cancel</button>
            </div>
        </div>
    </div>
<script>
// Global Constants and Data Definitions
const IMAGE_BASE_URL = 'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/GiftImages/';
const API_BASE_URL = 'https://gifthunter.onrender.com';
const BOT_USERNAME = 'Hunter_Case_bot';
const TON_TO_STARS_RATE = 250;
const STAR_ICON_URL = 'https://raw.githubusercontent.com/Vasiliy-katsyka/gifthunter/refs/heads/main/DMJTGStarsEmoji_AgADZxIAAjoUmVI.png';
const MINI_APP_NAME = 'app';
const TON_COIN_FULL_URL = 'https://case-bot.com/images/actions/ton.svg';
const currentUser = {
    id: null, username: null, first_name: 'User', last_name: null,
    walletAddress: null, walletAddressRaw: null, tonBalance: 0.00, starBalance: 0,
    inventory: [], referralCode: null, referralEarningsPending: 0, total_won_ton: 0,
    invited_friends_count: 0,
    photo_url: null
};
// --- In your <script> tag in index.html ---

const EMOJI_GIFTS = {
    "Heart": {
        id: "5170145012310081615",
        value: 15, // Star value
        imageFilename: "https://github.com/Vasiliy-katsyka/gifthunter/blob/main/gifts_emoji_by_gifts_changes_bot_AgADYEwAAiHMUUk.png?raw=true"
    },
    "Bear": {
        id: "5170233102089322756",
        value: 15, // Star value
        imageFilename: "https://github.com/Vasiliy-katsyka/gifthunter/blob/main/gifts_emoji_by_gifts_changes_bot_AgADomAAAvRzSEk.png?raw=true"
    },
    "Rose": {
        id: "5168103777563050263",
        value: 25, // Star value
        imageFilename: "https://github.com/Vasiliy-katsyka/gifthunter/blob/main/gifts_emoji_by_gifts_changes_bot_AgADslsAAqCxSUk.png?raw=true"
    },
    "Rocket": {
        id: "5170564780938756245",
        value: 50, // Star value
        imageFilename: "https://github.com/Vasiliy-katsyka/gifthunter/blob/main/gifts_emoji_by_gifts_changes_bot_AgAD9lAAAsBFUUk.png?raw=true"
    },
    "Bottle": {
        id: "6028601630662853006",
        value: 50, // Star value
        imageFilename: "https://github.com/Vasiliy-katsyka/gifthunter/blob/main/gifts_emoji_by_gifts_changes_bot_AgADA2cAAm0PqUs.png?raw=true"
    }
};
let currentOpenCaseOrSlot = null;
let selectedCaseMultiplier = 1;
let itemToWithdraw = null;
const upgradeChances = { 1.5: 50, 2: 35, 3: 25, 5: 15, 10: 8, 20: 3 };
let lastWonPrizesForOverlay = [];
let selectedUpgradeMultiplier = 1.5;
let spinAnimationTimeoutOuter = null;

let selectedItemForUpgrade = null;
let desiredItemForUpgrade = null;
let calculatedUpgradeMultiplier = 0;
let calculatedUpgradeChance = 0;
let currentUpgradePickerType = null;
let allAppGiftsForUpgrade = [];

// Add these with your other global variables

const bannersData = [
    {
        name: 'Subscribe',
        image: 'https://github.com/Vasiliy-katsyka/gifthunter/blob/main/IMG_20250828_153346_240.jpg?raw=true',
        url: 'https://t.me/CaseHunterNews'
    },
    {
        name: 'Case Promo',
        image: 'https://github.com/Vasiliy-katsyka/gifthunter/blob/main/IMG_20250828_153346_408.jpg?raw=true',
        url: null // No link for this banner
    }
];
let bannerCurrentIndex = 0;
let bannerAutoSwipeInterval;
let bannerTouchStartX = 0;
let bannerTouchMoveX = 0;
    
const GIFT_NAME_TO_ID_MAP = {
  "Santa Hat": "5983471780763796287","Signet Ring": "5936085638515261992","Precious Peach": "5933671725160989227","Plush Pepe": "5936013938331222567",
  "Spiced Wine": "5913442287462908725","Jelly Bunny": "5915502858152706668","Durov's Cap": "5915521180483191380","Perfume Bottle": "5913517067138499193",
  "Eternal Rose": "5882125812596999035","Berry Box": "5882252952218894938","Vintage Cigar": "5857140566201991735","Magic Potion": "5846226946928673709",
  "Kissed Frog": "5845776576658015084","Hex Pot": "5825801628657124140","Evil Eye": "5825480571261813595","Sharp Tongue": "5841689550203650524",
  "Trapped Heart": "5841391256135008713","Skull Flower": "5839038009193792264","Scared Cat": "5837059369300132790","Spy Agaric": "5821261908354794038",
  "Homemade Cake": "5783075783622787539","Genie Lamp": "5933531623327795414","Lunar Snake": "6028426950047957932","Party Sparkler": "6003643167683903930",
  "Jester Hat": "5933590374185435592","Witch Hat": "5821384757304362229","Hanging Star": "5915733223018594841","Love Candle": "5915550639663874519",
  "Cookie Heart": "6001538689543439169","Desk Calendar": "5782988952268964995","Jingle Bells": "6001473264306619020","Snow Mittens": "5980789805615678057",
  "Voodoo Doll": "5836780359634649414","Mad Pumpkin": "5841632504448025405","Hypno Lollipop": "5825895989088617224","B-Day Candle": "5782984811920491178",
  "Bunny Muffin": "5935936766358847989","Astral Shard": "5933629604416717361","Flying Broom": "5837063436634161765","Crystal Ball": "5841336413697606412",
  "Eternal Candle": "5821205665758053411","Swiss Watch": "5936043693864651359","Ginger Cookie": "5983484377902875708","Mini Oscar": "5879737836550226478",
  "Lol Pop": "5170594532177215681","Ion Gem": "5843762284240831056","Star Notepad": "5936017773737018241","Loot Bag": "5868659926187901653",
  "Love Potion": "5868348541058942091","Toy Bear": "5868220813026526561","Diamond Ring": "5868503709637411929","Sakura Flower": "5167939598143193218",
  "Sleigh Bell": "5981026247860290310","Top Hat": "5897593557492957738","Record Player": "5856973938650776169","Winter Wreath": "5983259145522906006",
  "Snow Globe": "5981132629905245483","Electric Skull": "5846192273657692751","Tama Gadget": "6023752243218481939","Candy Cane": "6003373314888696650",
  "Neko Helmet": "5933793770951673155","Jack-in-the-Box": "6005659564635063386","Easter Egg": "5773668482394620318",
  "Bonded Ring": "5870661333703197240", "Pet Snake": "6023917088358269866", "Snake Box": "6023679164349940429",
  "Xmas Stocking": "6003767644426076664", "Big Year": "6028283532500009446",
    "Holiday Drink": "6003735372041814769",
    "Gem Signet": "5859442703032386168",
    "Light Sword": "5897581235231785485",
    "Restless Jar": "5870784783948186838",
    "Nail Bracelet": "5870720080265871962",
    "Heroic Helmet": "5895328365971244193",
    "Bow Tie": "5895544372761461960",
    "Heart Locket": "5868455043362980631",
    "Lush Bouquet": "5871002671934079382",
    "Whip Cupcake": "5933543975653737112",
    "Joyful Bundle": "5870862540036113469",
    "Cupid Charm": "5868561433997870501",
    "Valentine Box": "5868595669182186720",
    "Snoop Dogg": "6014591077976114307",
    "Swag Bag": "6012607142387778152",
    "Snoop Cigar": "6012435906336654262",
    "Low Rider": "6014675319464657779",
    "Westside Sign": "6014697240977737490",
};

const UPDATED_FLOOR_PRICES_FRONTEND = {
    'Plush Pepe': 3889.0,    
    'Neko Helmet': 22.7,
    'Sharp Tongue': 29.8,
    "Durov's Cap": 609.0,    
    'Voodoo Doll': 13.9,
    'Vintage Cigar': 20.0,    
    'Astral Shard': 80.0,      
    'Scared Cat': 36.0,
    'Swiss Watch': 29.0,      
    'Perfume Bottle': 71.0,     
    'Precious Peach': 246.0,    
    'Toy Bear': 16.3,
    'Genie Lamp': 46.0,        
    'Loot Bag': 80.0,           
    'Kissed Frog': 24.0,        
    'Electric Skull': 24.9,
    'Diamond Ring': 14.0,       
    'Mini Oscar': 74.5,
    'Party Sparkler': 1.7,
    'Homemade Cake': 1.5,
    'Cookie Heart': 1.6,
    'Jack-in-the-box': 1.7,
    'Skull Flower': 5.7,
    'Lol Pop': 1.2,             
    'Hypno Lollipop': 1.78,      
    'Desk Calendar': 1.1,       
    'B-Day Candle': 1.1,
    'Record Player': 9.1,
    'Jelly Bunny': 2.6,
    'Tama Gadget': 1.6,
    'Snow Globe': 2.1,          
    'Eternal Rose': 12.0,
    'Love Potion': 8,
    'Top Hat': 7.7,
    'Berry Box': 3.4,
    'Bunny Muffin': 3,
    'Candy Cane': 1.4,
    'Crystal Ball': 6.0,
    'Easter Egg': 2.6,
    'Eternal Candle': 2.3,
    'Evil Eye': 3.1,
    'Flying Broom': 8.4,
    'Ginger Cookie': 1.7,
    'Hanging Star': 4.1,
    'Hex Pot': 2.2,
    'Ion Gem': 62.9,
    'Jester Hat': 1.6,
    'Jingle Bells': 1.7,
    'Love Candle': 6.0,
    'Lunar Snake': 1.3,
    'Mad Pumpkin': 12,
    'Magic Potion': 52.0,       
    'Pet Snake': 1.4,
    'Sakura Flower': 4.1,
    'Santa Hat': 2.0,
    'Signet Ring': 22.8,
    'Sleigh Bell': 5.0,
    'Snow Mittens': 2.9,
    'Spiced Wine': 2.1,
    'Spy Agaric': 2.9,
    'Star Notepad': 1.9,
    'Trapped Heart': 6.4,
    'Winter Wreath': 1.6,
    "Big Year": 1.5,
    "Snake Box": 1.3,
    "Bonded Ring": 43.5,
    "Xmas Stocking": 1.3,
    "Holiday Drink": 1.8,
    "Gem Signet": 55.9,
    "Light Sword": 2.8,
    "Restless Jar": 2.3,
    "Nail Bracelet": 107.8,
    "Heroic Helmet": 188.0,
    "Bow Tie": 2.9,
    "Heart Locket": 1170.0,
    "Lush Bouquet": 2.4,
    "Whip Cupcake": 1.4,
    "Joyful Bundle": 2.6,
    "Cupid Charm": 9.0,
    "Valentine Box": 3.7,
    "Snoop Dogg": 1.6,
    "Swag Bag": 1.8,
    "Snoop Cigar": 4.4,
    "Low Rider": 21.7,
    "Westside Sign": 44.5,
    'Heart': 0.06,
    'Bear': 0.06,
    'Rose': 0.1,
    'Rocket': 0.2,
    'Bottle': 0.2,
};
const KISSED_FROG_VARIANT_FLOORS={"Happy Pepe":500.0,"Tree Frog":150.0,"Brewtoad":150.0,"Puddles":150.0,"Honeyhop":150.0,"Melty Butter":150.0,"Lucifrog":150.0,"Zodiak Croak":150.0,"Count Croakula":150.0,"Lilie Pond":150.0,"Sweet Dream":150.0,"Frogmaid":150.0,"Rocky Hopper":150.0,"Icefrog":45.0,"Lava Leap":45.0,"Toadstool":45.0,"Desert Frog":45.0,"Cupid":45.0,"Hopberry":45.0,"Ms. Toad":45.0,"Trixie":45.0,"Prince Ribbit":45.0,"Pond Fairy":45.0,"Boingo":45.0,"Tesla Frog":45.0,"Starry Night":30.0,"Silver":30.0,"Ectofrog":30.0,"Poison":30.0,"Minty Bloom":30.0,"Sarutoad":30.0,"Void Hopper":30.0,"Ramune":30.0,"Lemon Drop":30.0,"Ectobloom":30.0,"Duskhopper":30.0,"Bronze":30.0,"Lily Pond":19.0,"Toadberry":19.0,"Frogwave":19.0,"Melon":19.0,"Sky Leaper":19.0,"Frogtart":19.0,"Peach":19.0,"Sea Breeze":19.0,"Lemon Juice":19.0,"Cranberry":19.0,"Tide Pod":19.0,"Brownie":19.0,"Banana Pox":19.0};
Object.assign(UPDATED_FLOOR_PRICES_FRONTEND, KISSED_FROG_VARIANT_FLOORS);

function generateImageFilename(nameOrUrl) {
    if (!nameOrUrl) return IMAGE_BASE_URL + 'placeholder.png';
    if (nameOrUrl.startsWith('http://') || nameOrUrl.startsWith('https://')) return nameOrUrl;

    // Check if the name is one of our special image gifts
    if (EMOJI_GIFTS[nameOrUrl]) {
        return EMOJI_GIFTS[nameOrUrl].imageFilename; // Return the new image URL
    }

    const name = nameOrUrl;
    if (name.toLowerCase().includes("ton") && name.toLowerCase().includes("prize")) return TON_COIN_FULL_URL;
    if (GIFT_NAME_TO_ID_MAP[name]) return `https://cdn.changes.tg/gifts/originals/${GIFT_NAME_TO_ID_MAP[name]}/Original.png`;
    if (Object.keys(KISSED_FROG_VARIANT_FLOORS).includes(name)) return `https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/${name.replace(/\s/g, '%20')}.png`;
    
    let filename = name.replace(/\s+/g, '-').replace(/&/g, 'and').replace(/'/g, "");
    if (name === "Durov's Cap") filename = "Durov's-Cap";
    if (name === "Vintage Cigar") filename = "Vintage-Cigar";
    if (name === "placeholder_nothing.png") return 'https://images.emojiterra.com/mozilla/512px/274c.png';
    if (['Amber', 'Midnight_Blue', 'Onyx_Black', 'Black'].includes(name.replace(/-/g, '_'))) filename = name.replace('-', '_');
    
    if (!/\.(jpeg|jpg|gif|png|svg)$/i.test(filename)) filename += '.png';
    return IMAGE_BASE_URL + filename;
}

function formatLargeNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
    }
    if (num >= 1000) {
        return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
    }
    return num.toString();
}
    
const finalKissedFrogPrizesWithConsolation = [
    {'name':'Happy Pepe','probability': 0.0000001, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Happy%20Pepe.png','floorPrice':500.0},
    {'name':'Tree Frog','probability': 0.0000005, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Tree%20Frog.png','floorPrice':150.0},
    {'name':'Brewtoad','probability': 0.0000005, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Brewtoad.png','floorPrice':150.0},
    {'name':'Puddles','probability': 0.0000005, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Puddles.png','floorPrice':150.0},
    {'name':'Honeyhop','probability': 0.0000005, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Honeyhop.png','floorPrice':150.0},
    {'name':'Melty Butter','probability': 0.0000005, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Melty%20Butter.png','floorPrice':150.0},
    {'name':'Lucifrog','probability': 0.0000005, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Lucifrog.png','floorPrice':150.0},
    {'name':'Zodiak Croak','probability': 0.0000005, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Zodiak%20Croak.png','floorPrice':150.0},
    {'name':'Count Croakula','probability': 0.0000005, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Count%20Croakula.png','floorPrice':150.0},
    {'name':'Lilie Pond','probability': 0.0000005, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Lilie%20Pond.png','floorPrice':150.0},
    {'name':'Sweet Dream','probability': 0.0000005, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Sweet%20Dream.png','floorPrice':150.0},
    {'name':'Frogmaid','probability': 0.0000005, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Frogmaid.png','floorPrice':150.0},
    {'name':'Rocky Hopper','probability': 0.0000005, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Rocky%20Hopper.png','floorPrice':150.0},
    {'name':'Icefrog','probability': 0.000002, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Icefrog.png','floorPrice':45.0},
    {'name':'Lava Leap','probability': 0.000002, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Lava%20Leap.png','floorPrice':45.0},
    {'name':'Toadstool','probability': 0.000002, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Toadstool.png','floorPrice':45.0},
    {'name':'Desert Frog','probability':0.000002,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Desert%20Frog.png','floorPrice':45.0},
    {'name':'Cupid','probability':0.000002,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Cupid.png','floorPrice':45.0},
    {'name':'Hopberry','probability':0.000002,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Hopberry.png','floorPrice':45.0},
    {'name':'Ms. Toad','probability':0.000002,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Ms.%20Toad.png','floorPrice':45.0},
    {'name':'Trixie','probability':0.000002,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Trixie.png','floorPrice':45.0},
    {'name':'Prince Ribbit','probability':0.000002,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Prince%20Ribbit.png','floorPrice':45.0},
    {'name':'Pond Fairy','probability':0.000002,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Pond%20Fairy.png','floorPrice':45.0},
    {'name':'Boingo','probability':0.000002,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Boingo.png','floorPrice':45.0},
    {'name':'Tesla Frog','probability':0.000002,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Tesla%20Frog.png','floorPrice':45.0},
    {'name':'Starry Night','probability': 0.00001, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Starry%20Night.png','floorPrice':30.0},
    {'name':'Silver','probability': 0.00001, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Silver.png','floorPrice':30.0},
    {'name':'Ectofrog','probability':0.00001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Ectofrog.png','floorPrice':30.0},
    {'name':'Poison','probability':0.00001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Poison.png','floorPrice':30.0},
    {'name':'Minty Bloom','probability':0.00001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Minty%20Bloom.png','floorPrice':30.0},
    {'name':'Sarutoad','probability':0.00001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Sarutoad.png','floorPrice':30.0},
    {'name':'Void Hopper','probability':0.00001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Void%20Hopper.png','floorPrice':30.0},
    {'name':'Ramune','probability':0.00001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Ramune.png','floorPrice':30.0},
    {'name':'Lemon Drop','probability':0.00001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Lemon%20Drop.png','floorPrice':30.0},
    {'name':'Ectobloom','probability':0.00001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Ectobloom.png','floorPrice':30.0},
    {'name':'Duskhopper','probability':0.00001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Duskhopper.png','floorPrice':30.0},
    {'name':'Bronze','probability':0.00001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Bronze.png','floorPrice':30.0},
    {'name':'Lily Pond','probability': 0.001, 'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Lily%20Pond.png','floorPrice':19.0},
    {'name':'Toadberry','probability':0.001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Toadberry.png','floorPrice':19.0},
    {'name':'Frogwave','probability':0.001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Frogwave.png','floorPrice':19.0},
    {'name':'Melon','probability':0.001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Melon.png','floorPrice':19.0},
    {'name':'Sky Leaper','probability':0.001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Sky%20Leaper.png','floorPrice':19.0},
    {'name':'Frogtart','probability':0.001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Frogtart.png','floorPrice':19.0},
    {'name':'Peach','probability':0.001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Peach.png','floorPrice':19.0},
    {'name':'Sea Breeze','probability':0.001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Sea%20Breeze.png','floorPrice':19.0},
    {'name':'Lemon Juice','probability':0.001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Lemon%20Juice.png','floorPrice':19.0},
    {'name':'Cranberry','probability':0.001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Cranberry.png','floorPrice':19.0},
    {'name':'Tide Pod','probability':0.001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Tide%20Pod.png','floorPrice':19.0},
    {'name':'Brownie','probability':0.001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Brownie.png','floorPrice':19.0},
    {'name':'Banana Pox','probability':0.001,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Banana%20Pox.png','floorPrice':19.0},
    {'name': 'Spy Agaric', 'probability': 0.20, 'imageFilename': generateImageFilename('Spy Agaric'), 'floorPrice': UPDATED_FLOOR_PRICES_FRONTEND['Spy Agaric']},
    {'name': 'Desk Calendar', 'probability': 0.78, 'imageFilename': generateImageFilename('Desk Calendar'), 'floorPrice': UPDATED_FLOOR_PRICES_FRONTEND['Desk Calendar']}
].sort((a,b) => (b.floorPrice || 0) - (a.floorPrice || 0));
let currentProbSumForKF = finalKissedFrogPrizesWithConsolation.reduce((sum,p)=>sum+p.probability,0);
let remainingProbForConsolation = 1.0 - currentProbSumForKF;
if(remainingProbForConsolation > 0.00001){finalKissedFrogPrizesWithConsolation.push({name:"Desk Calendar",probability:remainingProbForConsolation});}
finalKissedFrogPrizesWithConsolation.forEach(p=>{if(!p.imageFilename)p.imageFilename=generateImageFilename(p.name);if(p.floorPrice===undefined)p.floorPrice=UPDATED_FLOOR_PRICES_FRONTEND[p.name];});

// This is the clean, raw definition of all your cases.
// --- In index.html, REPLACE the entire casesData list ---
const casesData = [
    {'id':'all_in_01','name':'All In','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/All-In.jpg','priceTON':0.1,'prizes': [
        {'name':'Heart Locket','probability': 0.0000001}, // Jackpot!
        {'name':'Plush Pepe','probability': 0.0000005},
        {'name':'Durov\'s Cap','probability': 0.000005},
        {'name':'Precious Peach','probability': 0.00002},
        {'name':'Whip Cupcake', 'probability': 0.01}, // New common filler
        {'name':'Lol Pop','probability': 0.001},
        {'name': "Heart",  'probability': 0.25},
        {'name': "Bear",   'probability': 0.25},
        {'name': "Rose",   'probability': 0.20},
        {'name': "Rocket", 'probability': 0.1389734},
        {'name': "Bottle", 'probability': 0.15},
    ]},
    {'id':'small_billionaire_05','name':'Small Billionaire','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Small-Billionaire.jpg','priceTON':0.5,'prizes': [
        {'name':'Heroic Helmet','probability': 0.000005}, // New high-tier prize
        {'name':'Perfume Bottle','probability': 0.0001},
        {'name':'Vintage Cigar','probability': 0.00012},
        {'name':'Signet Ring','probability': 0.00013},
        {'name':'Swiss Watch','probability': 0.00015},
        {'name':'Holiday Drink', 'probability': 0.002},  // New mid-tier filler
        {'name':'Swag Bag', 'probability': 0.002},      // New mid-tier filler
        {'name':'Snake Box', 'probability': 0.005},
        {'name': "Heart",  'probability': 0.25},
        {'name': "Bear",   'probability': 0.25},
        {'name': "Rose",   'probability': 0.20},
        {'name': "Rocket", 'probability': 0.140495},
        {'name': "Bottle", 'probability': 0.15},
    ]},
    {'id':'lolpop','name':'Lol Pop Stash','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Lol-Pop.jpg','priceTON':2.0,'prizes': [
        {'name':'Plush Pepe','probability':0.0000001},
        {'name':'Neko Helmet','probability':0.00001},
        {'name':'Snoop Dogg', 'probability': 0.05},      // New Thematic Filler
        {'name':'Whip Cupcake', 'probability': 0.05},   // New Thematic Filler
        {'name':'Holiday Drink', 'probability': 0.05},  // New Thematic Filler
        {'name':'Swag Bag', 'probability': 0.05},      // New Thematic Filler
        {'name':'Snake Box', 'probability': 0.0005},
        {'name':'Pet Snake', 'probability': 0.0005},
        {'name':'Party Sparkler','probability':0.1},
        {'name':'Homemade Cake','probability':0.1},
        {'name':'Jack-in-the-box','probability':0.1},
        {'name':'Santa Hat','probability':0.1},
        {'name':'Jester Hat','probability':0.05},
        {'name':'Cookie Heart','probability':0.1},
        {'name':'Easter Egg','probability':0.05},
        {'name':'Lol Pop','probability':0.0988899},
        {'name':'Hypno Lollipop','probability':0.1},
    ]},
    {'id':'recordplayer','name':'Record Player Vault','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Record-Player.jpg','priceTON':3.0,'prizes': [
        {'name':'Plush Pepe','probability':0.0000001},
        {'name':'Bow Tie', 'probability': 0.02},         // New
        {'name':'Joyful Bundle', 'probability': 0.02},   // New
        {'name':'Lush Bouquet', 'probability': 0.02},    // New
        {'name':'Restless Jar', 'probability': 0.02},    // New
        {'name':'Light Sword', 'probability': 0.02},     // New
        {'name':'Tama Gadget','probability':0.001},
        {'name':'Record Player','probability':0.001},
        {'name':'Big Year', 'probability': 0.001},
        {'name':'Flying Broom','probability':0.001},
        {'name':'Skull Flower','probability':0.001},
        {'name':'Pet Snake', 'probability': 0.05},
        {'name':'Hex Pot','probability':0.1},
        {'name':'Snow Mittens','probability':0.1},
        {'name':'Spy Agaric','probability':0.0809999},
        {'name':'Star Notepad','probability':0.1},
        {'name':'Ginger Cookie','probability':0.1},
        {'name':'Party Sparkler','probability':0.15},
        {'name':'Lol Pop','probability':0.15},
        {'name':'Hypno Lollipop','probability':0.065},
    ]},
    {'id': 'girls_collection', 'name': 'Girl\'s Collection', 'imageFilename': 'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/girls.jpg', 'priceTON': 8.0, 'prizes': [
        {'name':'Heart Locket', 'probability': 0.00005},  // New Ultimate Prize
        {'name':'Nail Bracelet', 'probability': 0.0001}, // New Top Prize
        {'name':'Loot Bag', 'probability': 0.00001},
        {'name':'Genie Lamp', 'probability': 0.00001},
        {'name':'Cupid Charm', 'probability': 0.1},      // New Thematic Prize
        {'name':'Valentine Box', 'probability': 0.1},    // New Thematic Prize
        {'name':'Lush Bouquet', 'probability': 0.1},     // New Thematic Prize
        {'name':'Eternal Rose', 'probability': 0.1},
        {'name': 'Berry Box', 'probability': 0.2},
        {'name': 'Sakura Flower', 'probability': 0.2},
        {'name': 'Bunny Muffin', 'probability': 0.19983},
    ]},
    {'id': 'mens_collection', 'name': 'Men\'s Collection', 'imageFilename': 'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/men.jpg', 'priceTON': 8.0, 'prizes': [
        {'name':'Heroic Helmet', 'probability': 0.0001}, // New Top Prize
        {'name':'Durov\'s Cap', 'probability': 0.000001},
        {'name':'Westside Sign', 'probability': 0.05},   // New Snoop Dogg Set
        {'name':'Low Rider', 'probability': 0.1},        // New Snoop Dogg Set
        {'name':'Snoop Cigar', 'probability': 0.15},     // New Snoop Dogg Set
        {'name':'Swag Bag', 'probability': 0.2},         // New Snoop Dogg Set
        {'name':'Snoop Dogg', 'probability': 0.2},       // New Snoop Dogg Set
        {'name':'Vintage Cigar', 'probability': 0.0001},
        {'name':'Signet Ring', 'probability': 0.0001},
        {'name':'Top Hat', 'probability': 0.1},
        {'name':'Record Player', 'probability': 0.1},
        {'name':'Spiced Wine', 'probability': 0.099699},
    ]},
    {'id':'swisswatch','name':'Swiss Watch Box','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Swiss-Watch.jpg','priceTON':10.0,'prizes': [
        {'name':'Plush Pepe','probability':0.0000001},
        {'name':'Low Rider', 'probability': 0.02},       // New
        {'name':'Cupid Charm', 'probability': 0.05},     // New
        {'name':'Valentine Box', 'probability': 0.05},   // New
        {'name':'Snoop Cigar', 'probability': 0.05},     // New
        {'name':'Signet Ring','probability':0.00001},
        {'name':'Swiss Watch','probability':0.00001},
        {'name':'Electric Skull','probability':0.0001},
        {'name':'Voodoo Doll','probability':0.1},
        {'name':'Diamond Ring','probability':0.1},
        {'name':'Love Candle','probability':0.1},
        {'name':'Mad Pumpkin','probability':0.0798799},
        {'name':'Sleigh Bell','probability':0.1},
        {'name':'Top Hat','probability':0.1},
        {'name':'Trapped Heart','probability':0.1},
        {'name':'Love Potion','probability':0.1},
    ]},
    {'id':'kissedfrog','name':'Kissed Frog Pond','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Kissed-Frog.jpg','priceTON':20.0,
     'prizes': finalKissedFrogPrizesWithConsolation
    },
    {'id':'perfumebottle','name':'Perfume Chest','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Perfume-Bottle.jpg','priceTON': 20.0,'prizes': [
        {'name':'Heart Locket','probability':0.000001},
        {'name':'Nail Bracelet', 'probability': 0.0005},
        {'name':'Westside Sign', 'probability': 0.02},
        {'name':'Low Rider', 'probability': 0.02},
        {'name':'Plush Pepe','probability':0.0000001},
        {'name':'Bonded Ring', 'probability': 0.0000005},
        {'name':'Perfume Bottle','probability':0.000005},
        {'name':'Magic Potion','probability':0.00001},
        {'name':'Genie Lamp','probability':0.01},
        {'name':'Swiss Watch','probability':0.01},
        {'name':'Sharp Tongue','probability':0.02},
        {'name':'Neko Helmet','probability':0.02},
        {'name':'Kissed Frog','probability':0.05},
        {'name':'Electric Skull','probability':0.1},
        {'name':'Diamond Ring','probability':0.1},
        {'name':'Big Year', 'probability': 0.0894834},
        {'name':'Snake Box', 'probability': 0.5},
        {'name':'Pet Snake', 'probability': 0.05},
    ]},
    {'id':'vintagecigar','name':'Vintage Cigar Safe','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Vintage-Cigar.jpg','priceTON':40.0,'prizes': [
        {'name':'Heart Locket','probability':0.000005},
        {'name':'Heroic Helmet','probability':0.00005},
        {'name':'Nail Bracelet','probability':0.0001},
        {'name':'Gem Signet','probability':0.05},
        {'name':'Westside Sign','probability':0.05},
        {'name':'Plush Pepe','probability':0.0000001},
        {'name':'Mini Oscar','probability':0.00001},
        {'name':'Perfume Bottle','probability':0.01},
        {'name':'Scared Cat','probability':0.1},
        {'name':'Vintage Cigar','probability':0.1},
        {'name':'Swiss Watch','probability':0.05},
        {'name':'Sharp Tongue','probability':0.0898349},
        {'name':'Genie Lamp','probability':0.1},
        {'name':'Toy Bear','probability':0.15},
        {'name':'Neko Helmet','probability':0.1},
        {'name':'Snake Box', 'probability': 0.1},
        {'name':'Pet Snake', 'probability': 0.05},
    ]},
    {'id':'astralshard','name':'Astral Shard Relic','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Astral-Shard.jpg','priceTON':100.0,'prizes': [
        {'name':'Heart Locket','probability':0.0001},
        {'name':'Heroic Helmet','probability':0.05},
        {'name':'Nail Bracelet','probability':0.1},
        {'name':'Gem Signet','probability':0.1},
        {'name':'Plush Pepe','probability':0.0000001},
        {'name':'Durov\'s Cap','probability':0.0000005},
        {'name':'Precious Peach','probability':0.000001},
        {'name':'Bonded Ring', 'probability': 0.01},
        {'name':'Astral Shard','probability':0.05},
        {'name':'Ion Gem','probability':0.05},
        {'name':'Mini Oscar','probability':0.05},
        {'name':'Perfume Bottle','probability':0.05},
        {'name':'Magic Potion','probability':0.05},
        {'name':'Loot Bag','probability':0.0898984},
        {'name':'Scared Cat','probability':0.1},
        {'name':'Vintage Cigar','probability':0.1},
        {'name':'Swiss Watch','probability':0.1},
    ]},
    {'id':'plushpepe','name':'Plush Pepe Hoard','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Plush-Pepe.jpg','priceTON': 200.0,'prizes': [
        {'name':'Heart Locket','probability':0.05},
        {'name':'Heroic Helmet','probability':0.1},
        {'name':'Nail Bracelet','probability':0.1},
        {'name':'Plush Pepe','probability':0.000001},
        {'name':'Durov\'s Cap','probability':0.000005},
        {'name':'Precious Peach','probability':0.4},
        {'name':'Bonded Ring', 'probability': 0.2},
        {'name':'Astral Shard','probability': 0.149994},
    ]}
];
// --- CRUCIAL PROCESSING STEP ---
// This loop MUST run after the casesData array is defined.
// It adds the necessary floorPrice and imageFilename properties to each prize.
casesData.forEach(caseItem => {
    let totalProb = 0;
    caseItem.prizes.forEach(prize => {
        prize.floorPrice = UPDATED_FLOOR_PRICES_FRONTEND[prize.name] || 0;
        prize.imageFilename = generateImageFilename(prize.name); // This is safe now
        totalProb += prize.probability;
    });

    // A simple check to help you find errors in your probabilities
    if (Math.abs(totalProb - 1.0) > 0.001) {
        console.warn(`Probabilities for case "${caseItem.name}" do not sum to 1.0! Current sum is ${totalProb}`);
    }

    // Sort prizes by value for better display in the 'Possible Prizes' grid
    caseItem.prizes.sort((a, b) => (b.floorPrice || 0) - (a.floorPrice || 0));
});
// DOM Element References
const headerElements = {
    tonConnectButton: document.getElementById('ton-connect-button'),
    walletAddressDisplay: document.getElementById('wallet-address-display'),
    starBalanceSpan: document.getElementById('star-balance'),
    balanceDisplay: document.getElementById('balance')
};
const appNavButtons = document.querySelectorAll('.nav-button');
const pages = document.querySelectorAll('.page');
const casesGrid = document.getElementById('cases-grid');
const loadingScreen = document.getElementById('loading-screen');
const loadingStatusText = document.getElementById('loading-status');
const rouletteModal = document.getElementById('roulette-modal');
const rouletteCaseName = document.getElementById('roulette-case-name');
const rouletteWheelContainer = document.getElementById('roulette-wheel-container');
const spinButton = document.getElementById('spin-button');
const closeRouletteButton = document.getElementById('close-roulette-button');
const possiblePrizesDisplay = document.getElementById('possible-prizes-display');
const caseMultiplierSelector = document.querySelector('.case-multiplier-selector');
const rouletteReel1 = document.getElementById('roulette-reel-1');
const rouletteReel2 = document.getElementById('roulette-reel-2');
const rouletteReel3 = document.getElementById('roulette-reel-3');
const winOverlayModal = document.getElementById('win-overlay-modal');
const winOverlayPrizeImageContainer = document.getElementById('win-overlay-prize-image');
const winOverlayNameEl = document.getElementById('win-overlay-prize-name');
const winOverlayPrizeDetailsEl = document.getElementById('win-overlay-prize-details');
const winOverlaySaveBtn = document.getElementById('win-overlay-save-button');
const winOverlayConvertBtn = document.getElementById('win-overlay-convert-button');
const winOverlayConvertValue = document.getElementById('win-overlay-convert-value');
const withdrawModal = document.getElementById('withdraw-modal');
const closeWithdrawModalButton = document.getElementById('close-withdraw-modal-button');
const profileElements = {
    avatar: document.getElementById('profile-avatar'),
    username: document.getElementById('profile-username'),
    userid: document.getElementById('profile-userid'),
    balanceDisplay: document.getElementById('profile-balance-display'),
    walletAddress: document.getElementById('profile-wallet-address'),
    inventoryGrid: document.getElementById('inventory-grid'),
    inventoryCount: document.getElementById('inventory-count'),
    emptyInventoryMessage: document.getElementById('empty-inventory-message'),
    disconnectWalletButton: document.getElementById('disconnect-wallet-button'),
    depositAmountInput: document.getElementById('deposit-amount-input'),
    sellAllButton: document.getElementById('sell-all-button'),
    sellAllValueSpan: document.getElementById('sell-all-value'),
    promocodeInput: document.getElementById('promocode-input'),
    redeemPromocodeButton: document.getElementById('redeem-promocode-button')
};
const upgradePageElements = {
    selectedInventoryItemSlot: document.getElementById('selected-inventory-item-slot'),
    desiredUpgradeItemSlot: document.getElementById('desired-upgrade-item-slot'),
    upgradePickerContainer: document.getElementById('upgrade-picker-container'),
    upgradePickerTitle: document.getElementById('upgrade-picker-title'),
    upgradeItemsGrid: document.getElementById('upgrade-items-grid'),
    closeUpgradePickerButton: document.getElementById('close-upgrade-picker-button'),
    chanceDisplayContainer: document.getElementById('upgrade-chance-display-container'),
    chanceCircle: document.getElementById('upgrade-chance-circle'),
    chancePointer: document.getElementById('upgrade-chance-pointer'),
    calculatedMultiplierText: document.getElementById('upgrade-calculated-multiplier'),
    calculatedChanceText: document.getElementById('upgrade-calculated-chance'),
    doUpgradeButton: document.getElementById('do-upgrade-button'),
    upgradeResultModal: document.getElementById('upgrade-result-modal'),
    upgradeResultImageContainer: document.getElementById('upgrade-result-image-container'),
    upgradeResultTitle: document.getElementById('upgrade-result-title'),
    upgradeResultMessage: document.getElementById('upgrade-result-message'),
    closeUpgradeResultModalButton: document.getElementById('close-upgrade-result-modal-button'),
};
const inviteElements = {
    referralLink: document.getElementById('referral-link'),
    copyRefLinkButton: document.getElementById('copy-ref-link-button'),
    referralBalance: document.getElementById('referral-balance'),
    invitedCount: document.getElementById('invited-count'),
    withdrawReferralButton: document.getElementById('withdraw-referral-button'),
    invitedUsersListDisplay: document.getElementById('invited-users-list-display')
};
const leaderboardList = document.getElementById('leaderboard-list');
const depositInstructionsModal = document.getElementById('deposit-instructions-modal');
const tonTransferLink = document.getElementById('ton-transfer-link');
const confirmPaymentSentButton = document.getElementById('confirm-payment-sent-button');
const cancelDepositButton = document.getElementById('cancel-deposit-button');
const depositExpiryInfo = document.getElementById('deposit-expiry-info');
const depositStatusMessageEl = document.getElementById('deposit-status-message');
const depositLoader = document.getElementById('deposit-loader');
const depositWalletAddressEl = document.getElementById('deposit-wallet-address');
const depositCommentTextEl = document.getElementById('deposit-comment-text');
const copyDepositAddressBtn = document.getElementById('copy-deposit-address-button');
const copyDepositCommentBtn = document.getElementById('copy-deposit-comment-button');
let depositCommentText = ''; 
const VISUAL_ITEMS_PER_REEL_INITIAL = 10;
const VISUAL_ITEMS_PER_REEL_SPIN_BUFFER = 70;
let currentPendingDepositId = null;
let depositExpiryInterval = null;
let depositRecipientAddressRaw = '';

const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: 'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/tonconnect-manifest.json',
    buttonRootId: 'ton-connect-button'
});
let tgBackButton = null;
const backButtonHandlerStack = [];
let dataFetchedSuccessfully = false;
let tonConnectWalletInfo = null;

// Utility Functions
function _updateTgBackButton() {
    if (!tgBackButton) return;
    if (backButtonHandlerStack.length > 0) {
        const handler = backButtonHandlerStack[backButtonHandlerStack.length - 1];
        tgBackButton.offClick();
        tgBackButton.onClick(handler);
        tgBackButton.show();
    } else {
        tgBackButton.hide();
        tgBackButton.offClick();
    }
}
function pushTgBackButtonHandler(handler) {
    if (!tgBackButton) return;
    backButtonHandlerStack.push(handler);
    _updateTgBackButton();
}
function popTgBackButtonHandler() {
    if (!tgBackButton) return;
    if (backButtonHandlerStack.length > 0) backButtonHandlerStack.pop();
    _updateTgBackButton();
}
function clearTgBackButtonStack() {
    if (!tgBackButton) return;
    backButtonHandlerStack.length = 0;
    _updateTgBackButton();
}
function navigateBackToMainPage() {
    navigateToPage('main-page');
}
function closeRouletteModalWithBackButton() {
    closeRouletteModal();
}
function closeWinOverlayModalWithBackButton() {
    closeWinOverlayModal();
}
function closeDepositModalWithBackButton() {
    closeDepositInstructionsModal();
}
function updateLoadingStatus(message) {
    if (loadingStatusText) {
        loadingStatusText.textContent = message;
    }
}
async function apiRequest(endpoint, method = 'GET', body = null) {
    const headers = { 'Content-Type': 'application/json' };
    if (Telegram.WebApp.initData) headers['X-Telegram-Init-Data'] = Telegram.WebApp.initData;
    const config = { method, headers };
    if (body && (method === 'POST' || method === 'PUT')) config.body = JSON.stringify(body);
    try {
        const response = await fetch(API_BASE_URL + endpoint, config);
        if (!response.ok) {
            let errData; try { errData = await response.json(); } catch (e) { errData = { error: `HTTP ${response.status}: ${response.statusText}` }; }
            showTGNotification(errData.error || errData.message || `Request failed`, 'error');
            throw new Error(errData.error || errData.message);
        }
        return response.status === 204 ? null : await response.json();
    } catch (error) {
        if (!(error.message.includes("HTTP") || error.message.includes("Request failed"))) {
            showTGNotification(`Network: ${error.message}`, 'error');
        }
        throw error;
    }
}

// --- Add these new functions to your script ---

function renderBanners() {
    const bannerCarousel = document.getElementById('banner-carousel');
    if (!bannerCarousel) return;
    const slidesContainer = bannerCarousel.querySelector('.banner-slides');
    const paginationContainer = bannerCarousel.querySelector('.banner-pagination');
    slidesContainer.innerHTML = '';
    paginationContainer.innerHTML = '';

    bannersData.forEach((banner, index) => {
        // Create Slide
        const slide = document.createElement('div');
        slide.className = 'banner-slide';
        const img = document.createElement('img');
        img.src = banner.image;
        img.alt = banner.name;

        if (banner.url) {
            const link = document.createElement('a');
            link.href = "#"; // Use JS for navigation to avoid page reload
            link.onclick = (e) => {
                e.preventDefault();
                // Check if the link is a Telegram link
                if (banner.url.startsWith('t.me/') || banner.url.startsWith('https://t.me/')) {
                    Telegram.WebApp.openTelegramLink(banner.url);
                } else {
                    Telegram.WebApp.openLink(banner.url);
                }
            };
            link.appendChild(img);
            slide.appendChild(link);
        } else {
            slide.appendChild(img);
        }
        slidesContainer.appendChild(slide);

        // Create Dot
        const dot = document.createElement('div');
        dot.className = 'banner-dot';
        dot.onclick = () => {
            goToBannerSlide(index);
            resetBannerAutoSwipe(); // Reset timer when user clicks a dot
        };
        paginationContainer.appendChild(dot);
    });

    updateBannerPagination();
    setupBannerEventListeners();
    startBannerAutoSwipe();
}

function goToBannerSlide(index) {
    const slidesContainer = document.querySelector('.banner-slides');
    bannerCurrentIndex = (index + bannersData.length) % bannersData.length;
    slidesContainer.style.transform = `translateX(-${bannerCurrentIndex * 100}%)`;
    updateBannerPagination();
}

function updateBannerPagination() {
    const bannerDots = document.querySelectorAll('.banner-dot');
    bannerDots.forEach((dot, index) => {
        dot.classList.toggle('active', index === bannerCurrentIndex);
    });
}

function startBannerAutoSwipe() {
    stopBannerAutoSwipe();
    bannerAutoSwipeInterval = setInterval(() => {
        goToBannerSlide(bannerCurrentIndex + 1);
    }, 5000);
}

function stopBannerAutoSwipe() {
    clearInterval(bannerAutoSwipeInterval);
}

function resetBannerAutoSwipe() {
    stopBannerAutoSwipe();
    startBannerAutoSwipe();
}

function setupBannerEventListeners() {
    const slidesContainer = document.querySelector('.banner-slides');
    slidesContainer.addEventListener('touchstart', (e) => {
        stopBannerAutoSwipe();
        bannerTouchStartX = e.touches[0].clientX;
        bannerTouchMoveX = bannerTouchStartX;
    }, { passive: true });

    slidesContainer.addEventListener('touchmove', (e) => {
        bannerTouchMoveX = e.touches[0].clientX;
    }, { passive: true });

    slidesContainer.addEventListener('touchend', () => {
        const touchDiff = bannerTouchStartX - bannerTouchMoveX;
        const swipeThreshold = 50; // Minimum pixels to be considered a swipe

        if (touchDiff > swipeThreshold) {
            // Swiped left
            goToBannerSlide(bannerCurrentIndex + 1);
        } else if (touchDiff < -swipeThreshold) {
            // Swiped right
            goToBannerSlide(bannerCurrentIndex - 1);
        }
        startBannerAutoSwipe(); // Always restart the timer after user interaction
    });
}
    
function updateBalances() {
    // All balances are now in Stars
    const starBalance = Math.floor(currentUser.tonBalance * TON_TO_STARS_RATE);
    headerElements.starBalanceSpan.textContent = `${starBalance}`; // Keep ID for now, but it's stars
    document.querySelector('#profile-balance-display span').textContent = `${starBalance}`;
}
function navigateToPage(pageId) {
    pages.forEach(p => p.classList.remove('active'));
    document.getElementById(pageId)?.classList.add('active');
    appNavButtons.forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
    if (pageId === 'invite-page') {
        renderInvitedFriendsList();
    }
    if (tgBackButton) {
        if (pageId === 'main-page') {
            clearTgBackButtonStack();
        } else {
            while (backButtonHandlerStack.length > 0 && backButtonHandlerStack[backButtonHandlerStack.length - 1] !== navigateBackToMainPage) {
                popTgBackButtonHandler();
            }
            if (backButtonHandlerStack.length === 0) {
                pushTgBackButtonHandler(navigateBackToMainPage);
            }
        }
    }
    window.scrollTo(0, 0);
}

function updateModalBalanceDisplay() {
    const starBalance = Math.floor(currentUser.tonBalance * TON_TO_STARS_RATE);
    const balanceValueEl = document.getElementById('roulette-modal-balance-value');
    if (balanceValueEl && rouletteModal.classList.contains('active')) {
        balanceValueEl.textContent = formatLargeNumber(starBalance);
    }
}
    
function showTGNotification(message, type = 'info') {
    Telegram.WebApp.showAlert?.(message);
    if (Telegram.WebApp.HapticFeedback) {
        if (type === 'success') Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        else if (type === 'error') Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        else if (type === 'warning') Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
    }
}

// --- Replace the existing checkSubscription function ---
async function checkSubscription() {
    try {
        // This now returns the full object: { is_subscribed: boolean, missing: [...] }
        const response = await apiRequest('/api/check_subscription', 'GET');
        return response;
    } catch (error) {
        console.error("Subscription check failed:", error);
        // Default to allowing action if the API check itself fails
        return { is_subscribed: true, missing: [] };
    }
}
    
function renderHeader() {
    updateBalances();
}
function updateUIBasedOnWallet(wallet) {
    tonConnectWalletInfo = wallet;
    const connected = !!wallet;
    if (connected) {
        const addr = wallet.account.address;
        currentUser.walletAddressRaw = addr;
        const friendlyAddr = TonConnectSDK.toUserFriendlyAddress(addr, wallet.account.chain === TonConnectSDK.CHAIN.TESTNET);
        currentUser.walletAddress = friendlyAddr;
        headerElements.walletAddressDisplay.textContent = `${friendlyAddr.substring(0, 5)}...${friendlyAddr.substring(friendlyAddr.length - 4)}`;
        headerElements.walletAddressDisplay.classList.add('connected');
        headerElements.walletAddressDisplay.style.display = 'block';
        headerElements.balanceDisplay.classList.add('connected');
        headerElements.balanceDisplay.style.display = 'flex';
        headerElements.tonConnectButton.style.display = 'none';
        profileElements.walletAddress.textContent = friendlyAddr;
        profileElements.disconnectWalletButton.style.display = 'block';
    } else {
        currentUser.walletAddress = null;
        currentUser.walletAddressRaw = null;
        headerElements.walletAddressDisplay.classList.remove('connected');
        headerElements.walletAddressDisplay.style.display = 'none';
        headerElements.balanceDisplay.classList.remove('connected');
        headerElements.balanceDisplay.style.display = 'none';
        headerElements.tonConnectButton.style.display = 'block';
        profileElements.walletAddress.textContent = 'Not Connected';
        profileElements.disconnectWalletButton.style.display = 'none';
    }
    
    if (dataFetchedSuccessfully) {
        updateBalances();
        renderProfile();
    } else {
        // --- START OF THE FIX ---
        // Correctly reference 'starBalanceSpan' and set a placeholder value for stars.
        // This runs if the wallet connects before user data is fully loaded.
        headerElements.starBalanceSpan.textContent = '0';
        
        // Also update the profile page placeholder correctly without destroying the star icon.
        const profileBalanceSpan = document.querySelector('#profile-balance-display span');
        if (profileBalanceSpan) {
            profileBalanceSpan.textContent = '0';
        }
        // --- END OF THE FIX ---
    }
}
function renderCasesAndSlots() {
    renderCases();
}
function renderCases() {
    casesGrid.innerHTML = '';
    if (!casesData || casesData.length === 0) {
        casesGrid.innerHTML = "<p>Loading cases...</p>";
        return;
    }
    casesData.forEach(caseItem => {
        const card = document.createElement('div');
        card.className = 'case-card';
        card.dataset.caseId = caseItem.id;
        card.onclick = () => openRouletteModal(caseItem);
        const imgCont = document.createElement('div');
        imgCont.className = 'case-image-display';
        const img = document.createElement('img');
        img.loading = 'lazy';
        img.alt = caseItem.name;
        img.onerror = () => { imgCont.textContent = '❓'; imgCont.style.cssText = 'font-size:2.5em;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);'; };
        img.src = generateImageFilename(caseItem.imageFilename || caseItem.name);
        imgCont.appendChild(img);
        const nameCont = document.createElement('div');
        nameCont.className = 'case-name-container';
        const nameEl = document.createElement('div');
        nameEl.className = 'case-name';
        nameEl.textContent = caseItem.name;
        nameCont.appendChild(nameEl);

        const priceEl = document.createElement('div');
        priceEl.className = 'case-price';
        const casePriceInStars = Math.floor(caseItem.priceTON * TON_TO_STARS_RATE);
        priceEl.innerHTML = `<img src="${STAR_ICON_URL}" class="balance-icon" style="width: 18px; height: 18px;"> ${formatLargeNumber(casePriceInStars)}`;
        card.append(imgCont, priceEl);
        casesGrid.appendChild(card);
    });
}
function renderProfile() {
    profileElements.avatar.innerHTML = '';
    if (currentUser.photo_url) {
        const img = document.createElement('img');
        img.src = currentUser.photo_url;
        img.alt = currentUser.first_name ? `${currentUser.first_name}'s avatar` : 'User Avatar';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = 'inherit';
        profileElements.avatar.appendChild(img);
    } else {
        profileElements.avatar.textContent = currentUser.first_name ? currentUser.first_name.charAt(0).toUpperCase() : '?';
    }
    profileElements.username.textContent = (currentUser.first_name || currentUser.last_name) ? `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim() : currentUser.username || 'User';
    profileElements.userid.textContent = currentUser.id ? `#${currentUser.id}` : '#...';
    profileElements.walletAddress.textContent = currentUser.walletAddress || 'Not Connected';
    profileElements.disconnectWalletButton.style.display = currentUser.walletAddress ? 'block' : 'none';
    renderInventory();
}
function renderInventory() {
    profileElements.inventoryGrid.innerHTML = '';
    let totalValueInStars = 0;

    if (currentUser.inventory.length === 0) {
        profileElements.emptyInventoryMessage.style.display = 'block';
        profileElements.sellAllButton.style.display = 'none';
    } else {
        profileElements.emptyInventoryMessage.style.display = 'none';

        currentUser.inventory.forEach(item => {
            const itemValueInStars = Math.floor((item.currentValue || 0) * TON_TO_STARS_RATE);
            totalValueInStars += itemValueInStars;

            const itemDiv = document.createElement('div');
            itemDiv.className = 'inventory-item';

            const imgCont = document.createElement('div');
            imgCont.className = 'item-image-display';

            // Simplified image logic
            const img = document.createElement('img');
            img.src = generateImageFilename(item.imageFilename || item.name);
            img.alt = item.name;
            img.loading = 'lazy';
            imgCont.appendChild(img);
            
            // Note: item.is_emoji_gift might need adjustment depending on your backend response now
            const withdrawAction = `startWithdrawalProcess(${item.id}, ${!!EMOJI_GIFTS[item.name]})`;

            const valueHTML = `<div class="inventory-item-value">${itemValueInStars} ⭐</div>`;
            const actionsHTML = `<div class="inventory-item-actions">
                                    <button class="button button-secondary" onclick="${withdrawAction}">Withdraw</button>
                                    <button class="button button-secondary" onclick="handleSingleConvert(${item.id})">Convert</button>
                                 </div>`;

            itemDiv.innerHTML = `<div class="inventory-item-name" title="${item.name}">${item.name}</div>${valueHTML}${actionsHTML}`;
            itemDiv.insertBefore(imgCont, itemDiv.firstChild);
            profileElements.inventoryGrid.appendChild(itemDiv);
        });

        profileElements.sellAllButton.style.display = 'block';
        profileElements.sellAllValueSpan.textContent = totalValueInStars;
    }
    profileElements.inventoryCount.textContent = currentUser.inventory.length;
}
// --- Replace your existing renderLeaderboard function ---

async function renderLeaderboard() {
    try {
        const leaders = await apiRequest('/api/get_leaderboard');
        leaderboardList.innerHTML = '';
        leaders.forEach(l => {
            const entry = document.createElement('div');
            entry.className = 'leader-entry';
            if (l.user_id === currentUser.id) entry.classList.add('current-user-entry');
            
            // The 'income' value from the API is now in Stars
            const scoreHtml = `<div class="score">${formatLargeNumber(l.income)} <img src="${STAR_ICON_URL}" class="balance-icon" style="width: 16px; height: 16px; vertical-align: text-bottom;"></div>`;
            
            entry.innerHTML = `<div class="rank">${l.rank}</div><div class="avatar-placeholder">${l.avatarChar}</div><div class="info"><div class="name">${l.name}</div><div class="details">User ID: ${String(l.user_id).slice(0, 6)}...</div></div>${scoreHtml}`;
            leaderboardList.appendChild(entry);
        });
    } catch (e) {
        leaderboardList.innerHTML = '<p style="text-align:center;color:var(--text-placeholder);padding:20px;">Could not load leaders.</p>';
    }
}
// --- Replace your existing renderInvitePage function ---

function renderInvitePage() {
    inviteElements.referralLink.value = currentUser.referralCode ? `https://t.me/${BOT_USERNAME}?start=${currentUser.referralCode}` : 'Loading...';
    // The value from the API is now in Stars, so no conversion is needed.
    inviteElements.referralBalance.innerHTML = `${currentUser.referralEarningsPending} <img src="${STAR_ICON_URL}" class="balance-icon" style="width: 18px; height: 18px;">`;
    inviteElements.invitedCount.textContent = currentUser.invited_friends_count || 0;
}
async function renderInvitedFriendsList() {
    const listContainer = inviteElements.invitedUsersListDisplay;
    listContainer.innerHTML = '<div class="loader" style="margin: 10px auto; width: 30px; height: 30px;"></div>';
    try {
        const friends = await apiRequest('/api/get_invited_friends');
        if (friends && friends.length > 0) {
            listContainer.innerHTML = '';
            friends.forEach(friend => {
                const friendDiv = document.createElement('div');
                friendDiv.textContent = friend.name || `User #${friend.id}`;
                listContainer.appendChild(friendDiv);
            });
        } else {
            listContainer.innerHTML = '<p>No friends invited yet.</p>';
        }
    } catch (error) {
        console.error("Failed to fetch invited friends:", error);
        listContainer.innerHTML = '<p style="color: var(--danger-color);">Could not load friends list.</p>';
    }
}
function showWinOverlay(wonPrizesArray) {
    lastWonPrizesForOverlay = wonPrizesArray;
    winOverlayPrizeImageContainer.innerHTML = '';
    winOverlayPrizeDetailsEl.innerHTML = '';

    const convertiblePrizes = wonPrizesArray.filter(p => !p.is_emoji_gift);
    let totalConvertValueInTon = 0;

    if (wonPrizesArray.length === 0) return;

    if (wonPrizesArray.length === 1) {
        const prizeItem = wonPrizesArray[0];
        winOverlayNameEl.textContent = prizeItem.is_emoji_gift ? `You received a ${prizeItem.name} gift!` : `You Won: ${prizeItem.name}!`;
    } else {
        winOverlayNameEl.textContent = `You Won ${wonPrizesArray.length} Items!`;
    }

    let prizeDetailsHTML = '';
    wonPrizesArray.forEach(prizeItem => {
        const img = document.createElement('img');
        img.src = generateImageFilename(prizeItem.imageFilename || prizeItem.name);
        img.alt = prizeItem.name;
        winOverlayPrizeImageContainer.appendChild(img);

        // CORRECTED: Display prize value in Stars with the star icon
        const prizeValueInStars = Math.floor((prizeItem.currentValue || 0) * TON_TO_STARS_RATE);
        prizeDetailsHTML += `<div>- ${prizeItem.name} (${prizeValueInStars} <img src="${STAR_ICON_URL}" class="balance-icon" style="width: 12px; height: 12px; vertical-align: middle;">)</div>`;

        if (!prizeItem.is_emoji_gift) {
            totalConvertValueInTon += (prizeItem.currentValue || 0);
        }
    });
    winOverlayPrizeDetailsEl.innerHTML = prizeDetailsHTML;

    if (convertiblePrizes.length > 0) {
        // CORRECTED: Calculate and display total conversion value in Stars
        const totalConvertValueInStars = Math.floor(totalConvertValueInTon * TON_TO_STARS_RATE);
        winOverlayConvertValue.textContent = totalConvertValueInStars; // Just the number
        winOverlayConvertBtn.style.display = 'block';
    } else {
        winOverlayConvertBtn.style.display = 'none';
    }

    winOverlaySaveBtn.textContent = wonPrizesArray.every(p => p.is_emoji_gift) ? 'Awesome!' : 'Save to Collection';

    winOverlayModal.classList.add('active');
    if (tgBackButton) pushTgBackButtonHandler(closeWinOverlayModalWithBackButton);
    Telegram.WebApp.HapticFeedback?.notificationOccurred('success');
}
function closeWinOverlayModal() {
    if (tgBackButton) popTgBackButtonHandler();
    winOverlayModal.classList.remove('active');
    lastWonPrizesForOverlay = [];
}
function initializeRouletteVisuals(caseItem, multiplier) {
    const allReelContainers = [rouletteReel1, rouletteReel2, rouletteReel3];
    const itemHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--roulette-item-height').replace('px', '')) || 80;
    const rouletteRowVisibleHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--single-roulette-row-visual-height').replace('px', '')) || 260;
    allReelContainers.forEach(container => container.classList.remove('active'));
    let availablePrizes = caseItem && caseItem.prizes && caseItem.prizes.length > 0 ? caseItem.prizes : [{ name: "Loading...", imageFilename: "placeholder.png", is_ton_prize: false, floor_price: 0 }];
    
    for (let i = 0; i < multiplier; i++) {
        const reelContainer = allReelContainers[i];
        if (reelContainer) {
            reelContainer.classList.add('active');
            const spinnerReel = reelContainer.querySelector('.roulette-spinner-reel');
            spinnerReel.innerHTML = '';
            let defaultVisualItemsData = [];
            
            for (let j = 0; j < VISUAL_ITEMS_PER_REEL_INITIAL; j++) {
                const randomPrize = availablePrizes[Math.floor(Math.random() * availablePrizes.length)];
                defaultVisualItemsData.push(randomPrize);
            }

            defaultVisualItemsData.forEach(pData => {
                const itemEl = document.createElement('div');
                itemEl.className = 'roulette-item';

                // Simplified image logic
                const img = document.createElement('img');
                img.src = generateImageFilename(pData.imageFilename || pData.name);
                img.alt = pData.name;
                itemEl.appendChild(img);

                itemEl.dataset.prizeData = JSON.stringify({
                    name: pData.name,
                    imageFilename: pData.imageFilename,
                    is_ton_prize: pData.is_ton_prize,
                    floorPrice: pData.floor_price,
                    value: pData.value
                });
                spinnerReel.appendChild(itemEl);
            });

            spinnerReel.style.transition = 'none';
            const middleItemIndex = Math.floor(VISUAL_ITEMS_PER_REEL_INITIAL / 2);
            const initialScrollOffset = (middleItemIndex * itemHeight) + (itemHeight / 2) - (rouletteRowVisibleHeight / 2);
            spinnerReel.style.top = `-${initialScrollOffset}px`;
            void spinnerReel.offsetWidth;
        }
    }
}
function openRouletteModal(caseItem) {
    currentOpenCaseOrSlot = caseItem;
    selectedCaseMultiplier = 1;
    updateCaseMultiplierButtons();
    rouletteCaseName.textContent = caseItem.name;
    updateSpinButtonText();
    updateModalBalanceDisplay();

    // NEW: Update balance display inside the modal when it opens
    const starBalance = Math.floor(currentUser.tonBalance * TON_TO_STARS_RATE);
    const balanceValueEl = document.getElementById('roulette-modal-balance-value');
    if (balanceValueEl) {
        balanceValueEl.textContent = formatLargeNumber(starBalance);
    }

    possiblePrizesDisplay.innerHTML = '';
    const sortedPrizes = [...caseItem.prizes].sort((a, b) => (b.floorPrice || 0) - (a.floorPrice || 0));

    sortedPrizes.forEach(pData => {
        if (!pData || !pData.name) return;

        const displayPriceInStars = Math.floor((pData.floorPrice || 0) * TON_TO_STARS_RATE);

        const card = document.createElement('div');
        card.className = 'prize-card';

        const imgCont = document.createElement('div');
        imgCont.className = 'prize-card-image-placeholder';

        const img = document.createElement('img');
        img.src = generateImageFilename(pData.imageFilename || pData.name);
        img.alt = pData.name;
        imgCont.appendChild(img);

        const priceHTML = `<span class="prize-card-price">${formatLargeNumber(displayPriceInStars)} <img src="${STAR_ICON_URL}" class="balance-icon" style="width: 10px; height: 10px; vertical-align: baseline;"></span>`;
        const nameHTML = `<span class="prize-card-name">${pData.name}</span>`;

        card.innerHTML = `${priceHTML}${nameHTML}`;
        card.insertBefore(imgCont, card.firstChild);
        possiblePrizesDisplay.appendChild(card);
    });

    rouletteModal.classList.add('active');
    if (tgBackButton) pushTgBackButtonHandler(closeRouletteModalWithBackButton);
    Telegram.WebApp.HapticFeedback?.impactOccurred('light');
}
function updateSpinButtonText() {
    if (currentOpenCaseOrSlot && currentOpenCaseOrSlot.priceTON) {
        const priceInStars = Math.floor(currentOpenCaseOrSlot.priceTON * TON_TO_STARS_RATE);
        const totalPrice = priceInStars * selectedCaseMultiplier;
        spinButton.innerHTML = `Spin ${selectedCaseMultiplier}x (${totalPrice} <img src="${STAR_ICON_URL}" class="balance-icon" style="width: 16px; height: 16px;">)`;
    }
}
function updateCaseMultiplierButtons() {
    caseMultiplierSelector.querySelectorAll('button').forEach(btn => {
        btn.classList.toggle('active-multiplier', parseInt(btn.dataset.multiplier) === selectedCaseMultiplier);
        if (parseInt(btn.dataset.multiplier) === selectedCaseMultiplier) btn.classList.remove('button-secondary');
        else btn.classList.add('button-secondary');
    }); 
    initializeRouletteVisuals(currentOpenCaseOrSlot, selectedCaseMultiplier);
}
function closeRouletteModal() {
    if (tgBackButton) popTgBackButtonHandler();
    rouletteModal.classList.remove('active');
    currentOpenCaseOrSlot = null;
    if (spinAnimationTimeoutOuter) clearTimeout(spinAnimationTimeoutOuter);
    const allReelContainers = [rouletteReel1, rouletteReel2, rouletteReel3];
    allReelContainers.forEach(container => container.classList.remove('active'));
}
function getItemValue(prizeObject) {
    if (prizeObject.is_ton_prize) {
        return prizeObject.currentValue || prizeObject.value || 0;
    }
    return prizeObject.floorPrice || prizeObject.currentValue || 0; 
}
// --- In your <script> tag in index.html ---

// --- Replace the existing spinRoulette function ---
async function spinRoulette() {
    if (!currentOpenCaseOrSlot) return;

    // The check now returns a detailed status object
    const subStatus = await checkSubscription();

    if (!subStatus.is_subscribed) {
        // Dynamically create buttons for each missing channel
        const popupButtons = subStatus.missing.map(channelHandle => ({
            id: channelHandle, // We'll use the handle as the button ID
            type: 'default',
            text: `Join ${channelHandle}`
        }));
        // Add a cancel button
        popupButtons.push({ type: 'cancel' });

        Telegram.WebApp.showPopup({
            title: 'Subscription Required',
            message: 'Пожалуйста, подпишись на каналы чтобы получать новости и крутить кейсы!',
            buttons: popupButtons
        }, (buttonId) => {
            // If a channel button was clicked (not cancel)
            if (buttonId) {
                const url = 'https://t.me/' + buttonId.replace('@', '');
                Telegram.WebApp.openTelegramLink(url);
            }
        });
        return; // Stop the function here
    }

    spinButton.disabled = true;
    spinButton.textContent = 'Spinning...';
    Telegram.WebApp.HapticFeedback?.impactOccurred('light');

    // LIVE UPDATE: Visually deduct balance for responsiveness
    const costInTon = currentOpenCaseOrSlot.priceTON * selectedCaseMultiplier;
    const starBalanceBeforeSpin = Math.floor(currentUser.tonBalance * TON_TO_STARS_RATE);
    const costInStars = Math.floor(costInTon * TON_TO_STARS_RATE);

    if (starBalanceBeforeSpin < costInStars) {
        showTGNotification("Not enough Stars to spin.", "error");
        spinButton.disabled = false;
        updateSpinButtonText();
        return;
    }

    currentUser.tonBalance -= costInTon;
    updateBalances(); // Updates main header
    updateModalBalanceDisplay(); // Updates modal display

    const allReelContainers = [rouletteReel1, rouletteReel2, rouletteReel3];
    const activeSpinners = allReelContainers.filter(container => container.classList.contains('active')).map(container => container.querySelector('.roulette-spinner-reel'));

    if (activeSpinners.length === 0) {
        showTGNotification("No active reels to spin. Please select a multiplier.", "error");
        spinButton.disabled = false;
        updateSpinButtonText();
        // Revert balance change if spin doesn't happen
        currentUser.tonBalance += costInTon;
        updateBalances();
        updateModalBalanceDisplay();
        return;
    }

    const availablePrizes = currentOpenCaseOrSlot.prizes;
    const itemHeight = activeSpinners[0].querySelector('.roulette-item').offsetHeight;
    const rouletteRowVisibleHeight = activeSpinners[0].parentElement.clientHeight;
    const centerOffset = (rouletteRowVisibleHeight / 2);

    activeSpinners.forEach((spinnerReel, reelIndex) => {
        spinnerReel.style.transition = 'none';
        void spinnerReel.offsetWidth;
        for (let j = 0; j < VISUAL_ITEMS_PER_REEL_SPIN_BUFFER; j++) {
            const randomPrize = availablePrizes[Math.floor(Math.random() * availablePrizes.length)];
            const itemEl = document.createElement('div');
            itemEl.className = 'roulette-item';
            const img = document.createElement('img');
            img.src = generateImageFilename(randomPrize.imageFilename || randomPrize.name);
            img.alt = randomPrize.name;
            itemEl.appendChild(img);
            itemEl.dataset.prizeData = JSON.stringify({
                name: randomPrize.name,
                imageFilename: randomPrize.imageFilename,
                is_ton_prize: randomPrize.is_ton_prize,
                floorPrice: randomPrize.floor_price,
                value: randomPrize.value
            });
            spinnerReel.appendChild(itemEl);
        }
    });

    try {
        const result = await apiRequest('/api/open_case', 'POST', { case_id: currentOpenCaseOrSlot.id, multiplier: selectedCaseMultiplier });
        
        // IMPORTANT: Sync with the true balance from the server
        currentUser.tonBalance = result.new_balance_ton;
        updateBalances();
        updateModalBalanceDisplay();

        if (result.status === 'success' && result.won_prizes && result.won_prizes.length > 0) {
            if (spinAnimationTimeoutOuter) clearTimeout(spinAnimationTimeoutOuter);

            activeSpinners.forEach((spinnerReel, index) => {
                let currentReelItemsDOMElements = Array.from(spinnerReel.children);
                const actualWonPrizeBackendData = result.won_prizes[index] || (index === 0 && result.won_prizes[0]);
                if (!actualWonPrizeBackendData) {
                    console.warn(`No won prize data for reel ${index}. Skipping animation for this reel.`);
                    return;
                }

                const landingSpotIndex = VISUAL_ITEMS_PER_REEL_INITIAL + Math.floor(VISUAL_ITEMS_PER_REEL_SPIN_BUFFER / 2);

                if (currentReelItemsDOMElements[landingSpotIndex]) {
                    const targetEl = currentReelItemsDOMElements[landingSpotIndex];
                    const imgElement = targetEl.querySelector('img');
                    if (imgElement) {
                        imgElement.src = generateImageFilename(actualWonPrizeBackendData.imageFilename || actualWonPrizeBackendData.name);
                        imgElement.alt = actualWonPrizeBackendData.name;
                    }
                    targetEl.dataset.isWinner = 'true';
                    targetEl.dataset.prizeData = JSON.stringify(actualWonPrizeBackendData);
                } else {
                    console.warn(`Could not place winning item at target index ${landingSpotIndex}. Reel may be too short or index is off.`);
                }

                let scrollDist = (landingSpotIndex * itemHeight) + (itemHeight / 2) - centerOffset;
                const randomBiasRange = itemHeight * 0.4;
                let visualBiasOffsetPx = (Math.random() * randomBiasRange) - (randomBiasRange / 2);
                scrollDist += visualBiasOffsetPx;

                const nudgeRange = 3;
                const winningItemValue = getItemValue(actualWonPrizeBackendData);
                let nudgeValueThreshold = winningItemValue * 1.5;
                let bestNudgeCandidate = null;
                let maxNudgeAmount = itemHeight * 0.4;

                for (let j = 1; j <= nudgeRange; j++) {
                    const idxAbove = landingSpotIndex - j;
                    const idxBelow = landingSpotIndex + j;
                    if (idxAbove >= 0 && currentReelItemsDOMElements[idxAbove]) {
                        try {
                            const itemAboveData = JSON.parse(currentReelItemsDOMElements[idxAbove].dataset.prizeData);
                            const itemAboveValue = getItemValue(itemAboveData);
                            if (itemAboveValue > nudgeValueThreshold && (!bestNudgeCandidate || itemAboveValue > getItemValue(JSON.parse(bestNudgeCandidate.item.dataset.prizeData)))) {
                                bestNudgeCandidate = { item: currentReelItemsDOMElements[idxAbove], direction: 'above', distance: j };
                            }
                        } catch (e) {}
                    }
                    if (idxBelow < currentReelItemsDOMElements.length && currentReelItemsDOMElements[idxBelow]) {
                        try {
                            const itemBelowData = JSON.parse(currentReelItemsDOMElements[idxBelow].dataset.prizeData);
                            const itemBelowValue = getItemValue(itemBelowData);
                            if (itemBelowValue > nudgeValueThreshold && (!bestNudgeCandidate || itemBelowValue > getItemValue(JSON.parse(bestNudgeCandidate.item.dataset.prizeData)))) {
                                bestNudgeCandidate = { item: currentReelItemsDOMElements[idxBelow], direction: 'below', distance: j };
                            }
                        } catch (e) {}
                    }
                }

                if (bestNudgeCandidate) {
                    let nudgeMagnitude = maxNudgeAmount * (1 / (bestNudgeCandidate.distance + 1));
                    nudgeMagnitude = Math.min(nudgeMagnitude, maxNudgeAmount);
                    if (bestNudgeCandidate.direction === 'above') {
                        scrollDist -= nudgeMagnitude;
                    } else {
                        scrollDist += nudgeMagnitude;
                    }
                }

                const minScrollPosForWinner = (landingSpotIndex * itemHeight) + (itemHeight * 0.1) - centerOffset;
                const maxScrollPosForWinner = (landingSpotIndex * itemHeight) + (itemHeight * 0.9) - centerOffset;
                scrollDist = Math.max(minScrollPosForWinner, Math.min(maxScrollPosForWinner, scrollDist));

                spinnerReel.style.transition = `top 6s cubic-bezier(0.25, 0.1, 0.2, 1)`;
                spinnerReel.style.top = `-${scrollDist}px`;
            });

            const animationDuration = 6000;
            spinAnimationTimeoutOuter = setTimeout(() => {
                result.won_prizes.forEach(wp => {
                    const existingItemIndex = currentUser.inventory.findIndex(invItem => invItem.id === wp.id);
                    if (existingItemIndex === -1 && wp.id) {
                        currentUser.inventory.push({
                            id: wp.id, name: wp.name, imageFilename: wp.imageFilename,
                            currentValue: wp.currentValue, variant: wp.variant, is_ton_prize: wp.is_ton_prize || false,
                            is_emoji_gift: wp.is_emoji_gift
                        });
                    }
                });
                renderInventory();
                showWinOverlay(result.won_prizes);

                spinButton.disabled = false;
                updateSpinButtonText();

                activeSpinners.forEach(spinnerReel => {
                    const currentTop = parseFloat(spinnerReel.style.top.replace('px', ''));
                    const itemHeightCalc = spinnerReel.querySelector('.roulette-item') ? spinnerReel.querySelector('.roulette-item').offsetHeight : 80;
                    const itemsScrolledPast = Math.floor(Math.abs(currentTop) / itemHeightCalc);
                    const startIndex = Math.max(0, itemsScrolledPast - 10);
                    const endIndex = Math.min(spinnerReel.children.length, itemsScrolledPast + 10 + Math.ceil(rouletteRowVisibleHeight / itemHeightCalc) * 2);
                    const itemsToKeep = Array.from(spinnerReel.children).slice(startIndex, endIndex);
                    spinnerReel.innerHTML = '';
                    itemsToKeep.forEach(itemEl => spinnerReel.appendChild(itemEl));
                    spinnerReel.style.transition = 'none';
                    spinnerReel.style.top = `${currentTop + (startIndex * itemHeightCalc)}px`;
                    void spinnerReel.offsetWidth;
                });
            }, animationDuration + 100);
        } else {
            showTGNotification(result.error || result.message || 'Failed to open case.', 'error');
        }
    } catch (e) {
        console.error("Spin roulette error", e);
        // Revert the visual balance deduction if the API call fails
        currentUser.tonBalance += costInTon;
        updateBalances();
        updateModalBalanceDisplay();
        spinButton.disabled = false;
        updateSpinButtonText();
        showTGNotification("Error during spin. Please try again.", "error");
    }
}
    
async function handleSingleConvert(itemId) {
    // CORRECTED: Notification now says Stars
    const itemInInventory = currentUser.inventory.find(i => i.id === itemId);
    if (!itemInInventory) return;

    const itemValueInStars = Math.floor((itemInInventory.currentValue || 0) * TON_TO_STARS_RATE);
    const success = await convertItemToTon(itemId);
    if (success) {
        showTGNotification(`Item converted to ${itemValueInStars} Stars!`, 'success');
        updateBalances();
        renderInventory();
    }
}
async function convertItemToTon(itemId) {
    const itemInInventory = currentUser.inventory.find(i => i.id === itemId);
    if (itemInInventory && itemInInventory.is_ton_prize) {
        showTGNotification("Cannot convert TON prize.", "info");
        return false;
    }
    try {
        const res = await apiRequest('/api/convert_to_ton', 'POST', { inventory_item_id: parseInt(itemId) });
        if (res.status === 'success') {
            currentUser.tonBalance = res.new_balance_ton;
            currentUser.inventory = currentUser.inventory.filter(i => i.id !== parseInt(itemId));
            return true;
        } else {
            showTGNotification(res.error || res.message || 'Failed.', 'error');
            return false;
        }
    } catch (e) {
        showTGNotification("Conversion request failed.", "error");
        return false;
    }
}
// --- In your <script> tag in index.html ---

async function handleConvertAll() {
    if (lastWonPrizesForOverlay.length === 0) {
        showTGNotification("No items to convert.", "warning");
        return;
    }

    const itemsToConvert = lastWonPrizesForOverlay.filter(p => !p.is_emoji_gift && p.id);
    if (itemsToConvert.length === 0) {
        showTGNotification("No convertible items in this win.", "info");
        closeWinOverlayModal();
        return;
    }

    let totalValueInTon = 0;
    itemsToConvert.forEach(item => {
        totalValueInTon += (item.currentValue || 0);
    });
    const totalValueInStars = Math.floor(totalValueInTon * TON_TO_STARS_RATE);
    const confirmationMessage = `Are you sure you want to convert these items for ${totalValueInStars} Stars?`;

    Telegram.WebApp.showConfirm(confirmationMessage, async (ok) => {
        if (ok) {
            winOverlayConvertBtn.disabled = true; // Disable button while processing
            winOverlayConvertBtn.textContent = 'Converting...';

            let successCount = 0;
            let failCount = 0;
            for (const item of itemsToConvert) {
                const success = await convertItemToTon(item.id);
                if (success) successCount++;
                else failCount++;
            }

            // After all conversions, update the balances and UI
            updateBalances();
            renderInventory();

            // LIVE UPDATE: Update the balance in the case modal if it's still open
            updateModalBalanceDisplay();

            if (failCount > 0) {
                showTGNotification(`${successCount} item(s) converted. ${failCount} failed.`, 'warning');
            } else {
                showTGNotification(`${successCount} item(s) converted to Stars!`, 'success');
            }

            // Restore the button state before closing
            winOverlayConvertBtn.disabled = false;
            winOverlayConvertBtn.innerHTML = `Convert All for <span id="win-overlay-convert-value">${totalValueInStars}</span> <img src="${STAR_ICON_URL}" class="balance-icon" style="width: 16px; height: 16px;">`;
            
            closeWinOverlayModal();
        }
    });
}
async function handleUpgrade() {
    if (!selectedItemForUpgrade || !desiredItemForUpgrade) {
        showTGNotification("Please select both your item and the desired item.", 'warning');
        return;
    }
    upgradePageElements.doUpgradeButton.disabled = true;
    upgradePageElements.doUpgradeButton.textContent = "Upgrading...";
    Telegram.WebApp.HapticFeedback?.impactOccurred('medium');
    try {
        const res = await apiRequest('/api/upgrade_item_v2', 'POST', { 
            inventory_item_id: selectedItemForUpgrade.id,
            desired_item_name: desiredItemForUpgrade.name
        });
        await startUpgradeAnimation(res.status === 'success');
        if (res.status === 'success') {
            const upgradedItemData = res.item;
            currentUser.inventory = currentUser.inventory.filter(i => i.id !== selectedItemForUpgrade.id);
            currentUser.inventory.push(upgradedItemData);
            showUpgradeResultModal(true, selectedItemForUpgrade, upgradedItemData);
        } else {
            if (res.item_lost) {
                currentUser.inventory = currentUser.inventory.filter(i => i.id !== selectedItemForUpgrade.id);
            }
            showUpgradeResultModal(false, selectedItemForUpgrade, null);
        }
        renderInventory();
        updateBalances();
    } catch (e) {
        console.error("Upgrade error:", e);
        showTGNotification("An error occurred during upgrade. Please try again.", "error");
        upgradePageElements.chancePointer.classList.remove('spinning');
        upgradePageElements.chancePointer.style.transform = `translateX(-50%) rotate(0deg)`;
    } finally {
        upgradePageElements.doUpgradeButton.disabled = false;
    }
}
async function sellAllItems() {
    const sellableItems = currentUser.inventory.filter(i => !i.is_ton_prize);
    if (!sellableItems.length) {
        showTGNotification("No sellable items.", "info");
        return;
    }

    // CORRECTED: Confirmation alert for "Sell All" now shows Stars
    const valInStars = parseFloat(profileElements.sellAllValueSpan.textContent);
    const confirmationMessage = `Sell all non-TON items for approximately ${valInStars} Stars?`;

    if (Telegram.WebApp.showConfirm) {
        Telegram.WebApp.showConfirm(confirmationMessage, async (ok) => {
            if (ok) doSellAll();
        });
    } else if (confirm(confirmationMessage)) {
        doSellAll();
    }
}
async function doSellAll() {
    try {
        const res = await apiRequest('/api/sell_all_items', 'POST');
        if (res.status === 'success') {
            currentUser.tonBalance = res.new_balance_ton;
            currentUser.inventory = currentUser.inventory.filter(i => i.is_ton_prize);
            updateBalances();
            renderInventory();
            showTGNotification(res.message, "success");
        } else showTGNotification(res.message || "Failed.", "error");
    } catch (e) {
        showTGNotification("Sell all request failed.", "error");
    }
}
// --- In index.html, replace the existing startWithdrawalProcess function ---

function startWithdrawalProcess(inventoryItemId) {
    const item = currentUser.inventory.find(i => i.id === parseInt(inventoryItemId));
    if (!item) {
        showTGNotification("Item not found.", "error");
        return;
    }
    itemToWithdraw = item; // Store the whole item object

    // --- NEW DYNAMIC TEXT LOGIC ---
    const isEmoji = !!EMOJI_GIFTS[item.name];
    const withdrawItemNameEl = document.getElementById('withdraw-item-name');
    const modalBodyParagraph = withdrawModal.querySelector('.modal-body p');

    withdrawItemNameEl.textContent = item.name; // This is for the <h3> title

    if (isEmoji) {
        // Text for automated emoji withdrawal
        modalBodyParagraph.innerHTML = `Are you sure you want to withdraw your <strong>${item.name}</strong>? It will be sent directly to your chat with the bot.`;
    } else {
        // Text for manual admin withdrawal
        modalBodyParagraph.innerHTML = `Are you sure you want to request a withdrawal for <strong>${item.name}</strong>? An administrator will process your request shortly.`;
    }
    // --- END NEW DYNAMIC TEXT LOGIC ---

    withdrawModal.classList.add('active');
    if (tgBackButton) pushTgBackButtonHandler(closeWithdrawModal);
}
function closeWithdrawModal() {
    if (tgBackButton) popTgBackButtonHandler();
    withdrawModal.classList.remove('active');
    itemToWithdraw = null;
}

async function initiateDepositProcedure(currency) {
    const amountInput = profileElements.depositAmountInput;
    const amountStr = amountInput.value.trim();

    if (!amountStr) {
        showTGNotification("Please enter an amount to deposit.", "warning");
        return;
    }

    const amount = parseFloat(amountStr);

    if (isNaN(amount) || amount <= 0) {
        showTGNotification("Please enter a valid, positive amount.", "error");
        return;
    }

    // Determine API endpoint and payload based on the selected currency
    const isStarsDeposit = currency === 'stars';
    const endpoint = isStarsDeposit ? '/api/initiate_stars_deposit' : '/api/initiate_deposit';
    const payload = { amount: amount };

    // Set UI feedback on the correct button
    const buttonId = isStarsDeposit ? 'initiate-deposit-stars-button' : 'initiate-deposit-ton-button';
    const button = document.getElementById(buttonId);
    const originalButtonText = button.textContent;
    button.disabled = true;
    button.textContent = "Initializing...";

    try {
        const res = await apiRequest(endpoint, 'POST', payload);

        if (res.status === 'success') {
            if (isStarsDeposit) {
                // Handle Telegram Stars deposit via Telegram.WebApp.openInvoice
                Telegram.WebApp.openInvoice(res.invoice_link, (status) => {
                    if (status === 'paid') {
                        showTGNotification('Deposit successful! Your balance will be updated.', 'success');
                        // Fetch fresh user data to reflect the new balance
                        fetchInitialUserData().then(() => {
                            updateBalances();
                            renderProfile();
                        });
                    } else if (status === 'failed') {
                        showTGNotification('Payment failed. Please try again.', 'error');
                    } else if (status === 'cancelled') {
                        showTGNotification('Payment was cancelled.', 'warning');
                    }
                });
                // Clear input after initiating
                amountInput.value = '';

            } else {
                // Handle TON deposit using the existing modal flow
                currentPendingDepositId = res.pending_deposit_id;
                depositRecipientAddressRaw = res.recipient_address;
                depositCommentText = res.comment;
                const nanoAmt = res.final_amount_nano_ton;

                depositWalletAddressEl.textContent = depositRecipientAddressRaw;
                depositCommentTextEl.textContent = depositCommentText;
                tonTransferLink.href = `ton://transfer/${depositRecipientAddressRaw}?amount=${nanoAmt}&text=${encodeURIComponent(depositCommentText)}`;

                startDepositExpiryTimer(res.expires_at);

                // Reset modal state before showing
                depositStatusMessageEl.textContent = '';
                depositLoader.style.display = 'none';
                confirmPaymentSentButton.disabled = false;
                confirmPaymentSentButton.textContent = 'I Sent Funds';

                // Show the modal and set up back button
                depositInstructionsModal.classList.add('active');
                if (tgBackButton) {
                    pushTgBackButtonHandler(closeDepositModalWithBackButton);
                }
            }
        } else {
            // Handle API errors (e.g., invalid amount range, etc.)
            showTGNotification(res.message || res.error || 'Failed to initiate deposit.', 'error');
        }
    } catch (e) {
        console.error(`Error during ${currency} deposit initiation:`, e);
        showTGNotification("A network error occurred. Please try again.", "error");
    } finally {
        // Restore button state regardless of outcome
        button.disabled = false;
        button.textContent = originalButtonText;
    }
}
function startDepositExpiryTimer(expiresISO) {
    if (depositExpiryInterval) clearInterval(depositExpiryInterval);
    const expiry = new Date(expiresISO).getTime();
    function update() {
        const now = new Date().getTime();
        const dist = expiry - now;
        if (dist < 0) {
            clearInterval(depositExpiryInterval);
            depositExpiryInfo.textContent = "Expired.";
            confirmPaymentSentButton.disabled = true;
            tonTransferLink.classList.add('button-secondary');
            return;
        }
        const m = Math.floor((dist % (1e3 * 60 * 60)) / (1e3 * 60));
        const s = Math.floor((dist % (1e3 * 60)) / 1e3);
        depositExpiryInfo.textContent = `Expires in ${m}m ${s}s.`;
        tonTransferLink.classList.remove('button-secondary');
    }
    update();
    depositExpiryInterval = setInterval(update, 1e3);
}
async function verifyPaymentSent() {
    if (!currentPendingDepositId) {
        showTGNotification("No deposit.", "error");
        return;
    }
    confirmPaymentSentButton.disabled = true;
    confirmPaymentSentButton.textContent = "Verifying...";
    depositLoader.style.display = 'block';
    depositStatusMessageEl.textContent = 'Checking...';
    try {
        const res = await apiRequest('/api/verify_deposit', 'POST', { pending_deposit_id: currentPendingDepositId });
        if (res.status === 'success') {
            showTGNotification(res.message, 'success');
            currentUser.tonBalance = res.new_balance_ton;
            updateBalances();
            renderProfile();
            closeDepositInstructionsModal();
        } else if (res.status === 'pending') {
            depositStatusMessageEl.textContent = res.message;
            confirmPaymentSentButton.disabled = false;
            confirmPaymentSentButton.textContent = "Check Again";
        } else {
            showTGNotification(res.message || "Failed.", "error");
            depositStatusMessageEl.textContent = res.message || "Failed.";
            if (res.status === 'expired') tonTransferLink.classList.add('button-secondary');
            else {
                confirmPaymentSentButton.disabled = false;
                confirmPaymentSentButton.textContent = "Try Again";
            }
        }
    } catch (e) {
        depositStatusMessageEl.textContent = 'Error verifying.';
        confirmPaymentSentButton.disabled = false;
        confirmPaymentSentButton.textContent = "Try Again";
        showTGNotification("Verification request failed.", "error");
    } finally {
        if (depositLoader.style.display === 'block' && !depositStatusMessageEl.textContent.includes('Checking')) depositLoader.style.display = 'none';
    }
}
function closeDepositInstructionsModal() {
    if (tgBackButton) popTgBackButtonHandler();
    depositInstructionsModal.classList.remove('active');
    if (depositExpiryInterval) clearInterval(depositExpiryInterval);
    currentPendingDepositId = null;
    profileElements.depositAmountInput.value = '';
    tonTransferLink.href = '#';
    depositStatusMessageEl.textContent = '';
    depositLoader.style.display = 'none';
    depositExpiryInfo.textContent = '';
    depositWalletAddressEl.textContent = ''; 
    depositCommentTextEl.textContent = ''; 
}
async function redeemPromocode() {
    const code = profileElements.promocodeInput.value.trim();
    if (!code) {
        showTGNotification("Enter code.", "warning");
        return;
    }
    profileElements.redeemPromocodeButton.disabled = true;
    try {
        const res = await apiRequest('/api/redeem_promocode', 'POST', { promocode_text: code });
        if (res.status === 'success') {
            currentUser.tonBalance = res.new_balance_ton;
            updateBalances();
            showTGNotification(res.message, 'success');
            profileElements.promocodeInput.value = '';
        } else showTGNotification(res.message || res.error || "Failed.", "error");
    } catch (e) {
        showTGNotification("Promocode request failed.", "error");
    } finally {
        profileElements.redeemPromocodeButton.disabled = false;
    }
}
function populateAllAppGifts() {
    const uniqueGifts = new Map();
    casesData.forEach(caseItem => {
        caseItem.prizes.forEach(prize => {
            if (prize.name && prize.name !== 'Nothing' && !prize.is_ton_prize) {
                if (!uniqueGifts.has(prize.name)) {
                    uniqueGifts.set(prize.name, {
                        name: prize.name,
                        imageFilename: prize.imageFilename || generateImageFilename(prize.name),
                        floorPrice: UPDATED_FLOOR_PRICES_FRONTEND[prize.name] || 0
                    });
                }
            }
        });
    });
    for (const name in UPDATED_FLOOR_PRICES_FRONTEND) {
        if (!uniqueGifts.has(name) && name !== 'Nothing') {
             uniqueGifts.set(name, {
                name: name,
                imageFilename: generateImageFilename(name),
                floorPrice: UPDATED_FLOOR_PRICES_FRONTEND[name]
            });
        }
    }
    allAppGiftsForUpgrade = Array.from(uniqueGifts.values()).sort((a,b) => a.floorPrice - b.floorPrice);
}
function openUpgradeItemPicker(type) {
    currentUpgradePickerType = type;
    upgradePageElements.upgradeItemsGrid.innerHTML = '';
    if (type === 'inventory') {
        upgradePageElements.upgradePickerTitle.textContent = "Select Your Item from Inventory";
        const userInventoryForUpgrade = currentUser.inventory.filter(item => !item.is_ton_prize && item.currentValue > 0);
        if (userInventoryForUpgrade.length === 0) {
            upgradePageElements.upgradeItemsGrid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color: var(--text-placeholder);">Your inventory is empty or has no upgradable items.</p>';
        } else {
            userInventoryForUpgrade.forEach(item => {
                const card = createUpgradeableItemCard(item, 'inventory');
                upgradePageElements.upgradeItemsGrid.appendChild(card);
            });
        }
    } else if (type === 'desired') {
        if (!selectedItemForUpgrade) {
            showTGNotification("Please select your item first.", "warning");
            return;
        }
        upgradePageElements.upgradePickerTitle.textContent = "Select Desired Item";
        const potentialDesiredItems = allAppGiftsForUpgrade.filter(
            gift => gift.floorPrice > selectedItemForUpgrade.currentValue
        );
        if (potentialDesiredItems.length === 0) {
            upgradePageElements.upgradeItemsGrid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color: var(--text-placeholder);">No items available for upgrade with higher value.</p>';
        } else {
             potentialDesiredItems.forEach(gift => {
                const card = createUpgradeableItemCard(gift, 'desired');
                upgradePageElements.upgradeItemsGrid.appendChild(card);
            });
        }
    }
    upgradePageElements.upgradePickerContainer.style.display = 'block';
}
function closeUpgradeItemPicker() {
    upgradePageElements.upgradePickerContainer.style.display = 'none';
    currentUpgradePickerType = null;
}
function createUpgradeableItemCard(itemData, type) {
    const card = document.createElement('div');
    card.className = 'inventory-item';
    const imgCont = document.createElement('div');
    imgCont.className = 'item-image-display';
    const img = document.createElement('img');
    img.src = itemData.imageFilename || generateImageFilename(itemData.name);
    img.alt = itemData.name;
    imgCont.appendChild(img);
    const nameEl = document.createElement('div');
    nameEl.className = 'inventory-item-name';
    nameEl.textContent = itemData.name;
    const valueEl = document.createElement('div');
    valueEl.className = 'inventory-item-value';

    // CORRECTED: Show value in Stars
    const valueInStars = Math.floor((type === 'inventory' ? itemData.currentValue : itemData.floorPrice) * TON_TO_STARS_RATE);
    valueEl.innerHTML = `${valueInStars} <img src="${STAR_ICON_URL}" class="balance-icon" style="width: 12px; height: 12px; vertical-align: middle;">`;

    const actionsEl = document.createElement('div');
    actionsEl.className = 'inventory-item-actions';
    const selectBtn = document.createElement('button');
    selectBtn.className = 'button';
    selectBtn.textContent = 'Select';
    if (type === 'inventory') {
        selectBtn.onclick = () => handleSelectInventoryItemForUpgrade(itemData.id);
    } else {
        selectBtn.onclick = () => handleSelectDesiredItemForUpgrade(itemData.name);
    }
    actionsEl.appendChild(selectBtn);
    card.appendChild(imgCont);
    card.appendChild(nameEl);
    card.appendChild(valueEl);
    card.appendChild(actionsEl);
    return card;
}
function updateSlotDisplay(slotElement, itemData, type) {
    const placeholder = slotElement.querySelector('.slot-placeholder');
    const display = slotElement.querySelector('.slot-item-display');
    if (itemData) {
        display.querySelector('img').src = itemData.imageFilename || generateImageFilename(itemData.name);
        display.querySelector('img').alt = itemData.name;
        display.querySelector('.slot-item-name').textContent = itemData.name;
        
        // CORRECTED: Show value in Stars
        const valueInStars = Math.floor((type === 'inventory' ? itemData.currentValue : itemData.floorPrice) * TON_TO_STARS_RATE);
        display.querySelector('.slot-item-value').innerHTML = `${valueInStars} <img src="${STAR_ICON_URL}" class="balance-icon" style="width: 14px; height: 14px; vertical-align: middle;">`;

        placeholder.style.display = 'none';
        display.style.display = 'flex';
        display.style.flexDirection = 'column';
    } else {
        placeholder.style.display = 'flex';
        display.style.display = 'none';
    }
}
function handleSelectInventoryItemForUpgrade(inventoryItemId) {
    const item = currentUser.inventory.find(i => i.id === inventoryItemId);
    if (item) {
        selectedItemForUpgrade = { ...item };
        updateSlotDisplay(upgradePageElements.selectedInventoryItemSlot, selectedItemForUpgrade, 'inventory');
        desiredItemForUpgrade = null;
        updateSlotDisplay(upgradePageElements.desiredUpgradeItemSlot, null, 'desired');
        calculateAndDisplayUpgradeStats();
        closeUpgradeItemPicker();
    }
}
function handleSelectDesiredItemForUpgrade(itemName) {
    const item = allAppGiftsForUpgrade.find(g => g.name === itemName);
    if (item) {
        desiredItemForUpgrade = { ...item };
        updateSlotDisplay(upgradePageElements.desiredUpgradeItemSlot, desiredItemForUpgrade, 'desired');
        calculateAndDisplayUpgradeStats();
        closeUpgradeItemPicker();
    }
}
function calculateAndDisplayUpgradeStats() {
    if (selectedItemForUpgrade && desiredItemForUpgrade) {
        if (selectedItemForUpgrade.currentValue <= 0) {
            calculatedUpgradeMultiplier = 0;
            calculatedUpgradeChance = 0;
            showTGNotification("Selected item has no value.", "error");
        } else {
            calculatedUpgradeMultiplier = desiredItemForUpgrade.floorPrice / selectedItemForUpgrade.currentValue;
            const xEffective = Math.max(1.01, calculatedUpgradeMultiplier);
            const maxChance = 75;
            const minChance = 3;
            const riskFactor = 0.60;
            let chance = maxChance * Math.pow(riskFactor, xEffective - 1);
            calculatedUpgradeChance = Math.min(maxChance, Math.max(minChance, chance));
        }
        upgradePageElements.calculatedMultiplierText.textContent = `${calculatedUpgradeMultiplier.toFixed(2)}x`;
        upgradePageElements.calculatedChanceText.textContent = `${calculatedUpgradeChance.toFixed(1)}% Шанс`;
        upgradePageElements.doUpgradeButton.disabled = false;
        upgradePageElements.doUpgradeButton.textContent = "Attempt Upgrade";
        const winAngle = (calculatedUpgradeChance / 100) * 360;
        document.documentElement.style.setProperty('--upgrade-win-segment-angle', `${winAngle}deg`);
    } else {
        calculatedUpgradeMultiplier = 0;
        calculatedUpgradeChance = 0;
        upgradePageElements.calculatedMultiplierText.textContent = "--x";
        upgradePageElements.calculatedChanceText.textContent = "--% Шанс";
        upgradePageElements.doUpgradeButton.disabled = true;
        upgradePageElements.doUpgradeButton.textContent = "Select Items to Upgrade";
        document.documentElement.style.setProperty('--upgrade-win-segment-angle', `0deg`);
    }
    upgradePageElements.chancePointer.classList.remove('spinning');
    upgradePageElements.chancePointer.style.transform = `translateX(-50%) rotate(0deg)`;
}

// --- Add this event listener to your JavaScript, near your other listeners ---

document.getElementById('support-button').addEventListener('click', () => {
    // This uses the Telegram WebApp API to open a link to the support chat
    Telegram.WebApp.openTelegramLink('https://t.me/sellerframent');
});

document.addEventListener('DOMContentLoaded', () => {
    // Now that the document is loaded, we can safely find our buttons.
    const depositStarsButton = document.getElementById('initiate-deposit-stars-button');
    const depositTonButton = document.getElementById('initiate-deposit-ton-button');

    // It's a good practice to check if the elements were actually found before adding listeners.
    if (depositStarsButton) {
        depositStarsButton.addEventListener('click', () => initiateDepositProcedure('stars'));
    } else {
        console.error("Could not find the 'initiate-deposit-stars-button' element.");
    }

    if (depositTonButton) {
        depositTonButton.addEventListener('click', () => initiateDepositProcedure('ton'));
    } else {
        console.error("Could not find the 'initiate-deposit-ton-button' element.");
    }

    // You should put ALL of your other initial event listeners and setup code
    // that interacts with HTML elements inside this DOMContentLoaded block.
    // For example:
    const redeemButton = document.getElementById('redeem-promocode-button');
    if (redeemButton) {
        redeemButton.addEventListener('click', redeemPromocode);
    }
});
    
let upgradeSpinTimeout;
function startUpgradeAnimation(isSuccess) {
    const pointer = upgradePageElements.chancePointer;
    pointer.classList.remove('spinning');
    pointer.style.transform = `translateX(-50%) rotate(0deg)`;
    void pointer.offsetWidth;
    const winSegmentAngle = (calculatedUpgradeChance / 100) * 360;
    const safetyMargin = 5;
    let targetAngle;
    if (isSuccess) {
        targetAngle = Math.random() * (winSegmentAngle - 2 * safetyMargin) + safetyMargin;
    } else {
        const loseSegmentStart = winSegmentAngle;
        const loseSegmentAngle = 360 - winSegmentAngle;
        targetAngle = loseSegmentStart + (Math.random() * (loseSegmentAngle - 2 * safetyMargin) + safetyMargin);
    }
    const fullSpins = 3 + Math.floor(Math.random() * 3);
    const finalAngle = fullSpins * 360 + targetAngle;
    pointer.classList.add('spinning');
    pointer.style.transform = `translateX(-50%) rotate(${finalAngle}deg)`;
    return new Promise(resolve => {
        if(upgradeSpinTimeout) clearTimeout(upgradeSpinTimeout);
        upgradeSpinTimeout = setTimeout(resolve, 5100);
    });
}
function showUpgradeResultModal(isSuccess, originalItem, newItemData) {
    const modal = upgradePageElements.upgradeResultModal;
    const titleEl = upgradePageElements.upgradeResultTitle;
    const messageEl = upgradePageElements.upgradeResultMessage;
    const imageContainer = upgradePageElements.upgradeResultImageContainer;
    imageContainer.innerHTML = '';
    if (isSuccess && newItemData) {
        titleEl.textContent = "Upgrade Successful!";
        titleEl.style.color = 'var(--success-color)';
        messageEl.textContent = `Your ${originalItem.name} has been upgraded to ${newItemData.name}!`;
        const img = document.createElement('img');
        img.src = newItemData.imageFilename || generateImageFilename(newItemData.name);
        img.alt = newItemData.name;
        imageContainer.appendChild(img);
    } else {
        titleEl.textContent = "Upgrade Failed";
        titleEl.style.color = 'var(--danger-color)';
        messageEl.textContent = `Unfortunately, your ${originalItem.name} was lost in the attempt.`;
        const img = document.createElement('img');
        img.src = originalItem.imageFilename || generateImageFilename(originalItem.name);
        img.alt = originalItem.name;
        imageContainer.appendChild(img);
    }
    modal.classList.add('active');
    Telegram.WebApp.HapticFeedback?.notificationOccurred(isSuccess ? 'success' : 'error');
}
function closeUpgradeResultModal() {
    upgradePageElements.upgradeResultModal.classList.remove('active');
    selectedItemForUpgrade = null;
    desiredItemForUpgrade = null;
    updateSlotDisplay(upgradePageElements.selectedInventoryItemSlot, null, 'inventory');
    updateSlotDisplay(upgradePageElements.desiredUpgradeItemSlot, null, 'desired');
    calculateAndDisplayUpgradeStats();
}

// Event Listeners
upgradePageElements.selectedInventoryItemSlot.addEventListener('click', () => openUpgradeItemPicker('inventory'));
upgradePageElements.desiredUpgradeItemSlot.addEventListener('click', () => openUpgradeItemPicker('desired'));
upgradePageElements.closeUpgradePickerButton.addEventListener('click', closeUpgradeItemPicker);
upgradePageElements.doUpgradeButton.addEventListener('click', handleUpgrade);
upgradePageElements.closeUpgradeResultModalButton.addEventListener('click', closeUpgradeResultModal);
appNavButtons.forEach(b => b.addEventListener('click', () => navigateToPage(b.dataset.page)));
spinButton.addEventListener('click', spinRoulette);
closeRouletteButton.addEventListener('click', closeRouletteModal);
winOverlaySaveBtn.addEventListener('click', closeWinOverlayModal);
winOverlayConvertBtn.addEventListener('click', handleConvertAll);
caseMultiplierSelector.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', e => {
        selectedCaseMultiplier = parseInt(e.target.dataset.multiplier);
        updateCaseMultiplierButtons();
        updateSpinButtonText();
    });
});
profileElements.disconnectWalletButton.addEventListener('click', () => tonConnectUI.disconnect());
profileElements.redeemPromocodeButton.addEventListener('click', redeemPromocode);
copyDepositAddressBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(depositRecipientAddressRaw)
        .then(() => showTGNotification("Address copied!", 'success'))
        .catch(() => showTGNotification("Failed to copy address.", 'error'));
});
closeWithdrawModalButton.addEventListener('click', closeWithdrawModal);
// --- In index.html, replace the existing 'confirm-withdraw-button' event listener ---

document.getElementById('confirm-withdraw-button').addEventListener('click', async () => {
    if (!itemToWithdraw) {
        showTGNotification("No item selected for withdrawal.", "error");
        return;
    }

    // --- NEW LOGIC: Decide which endpoint to call ---
    const isEmoji = !!EMOJI_GIFTS[itemToWithdraw.name];
    const endpoint = isEmoji ? '/api/withdraw_emoji_gift' : '/api/request_manual_withdrawal';
    // --- END NEW LOGIC ---

    const confirmButton = document.getElementById('confirm-withdraw-button');
    confirmButton.disabled = true;
    confirmButton.textContent = 'Processing...';

    try {
        const response = await apiRequest(endpoint, 'POST', {
            inventory_item_id: itemToWithdraw.id
        });

        if (response.status === 'success') {
            const successMessage = isEmoji ? response.message : "Withdrawal request sent successfully!";
            showTGNotification(successMessage, 'success');
            
            // Remove the item from the local state and re-render the inventory
            currentUser.inventory = currentUser.inventory.filter(i => i.id !== itemToWithdraw.id);
            renderInventory();
        } else {
            showTGNotification(response.error || "Failed to process withdrawal.", 'error');
        }
    } catch (error) {
        showTGNotification("An error occurred while sending the request.", "error");
    } finally {
        // Reset button and close the modal regardless of outcome
        confirmButton.disabled = false;
        confirmButton.textContent = 'Confirm';
        closeWithdrawModal();
    }
});
copyDepositCommentBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(depositCommentText)
        .then(() => showTGNotification("Comment copied!", 'success'))
        .catch(() => showTGNotification("Failed to copy comment.", 'error'));
});
inviteElements.copyRefLinkButton.addEventListener('click', () => {
    navigator.clipboard.writeText(inviteElements.referralLink.value).then(() => showTGNotification("Copied!", 'success')).catch(() => showTGNotification("Failed.", 'error'));
});
// --- Replace your existing 'withdrawReferralButton' event listener ---

inviteElements.withdrawReferralButton.addEventListener('click', async () => {
    try {
        const res = await apiRequest('/api/withdraw_referral_earnings', 'POST');
        if (res.status === 'success') {
            // Update balances from the API response
            currentUser.tonBalance = res.new_balance_ton;
            currentUser.referralEarningsPending = res.new_referral_earnings_pending; // This will be 0
            
            // Re-render UI elements
            updateBalances();
            renderInvitePage();
            showTGNotification(res.message, 'success');
        } else {
            showTGNotification(res.message || "Failed.", "error");
        }
    } catch (e) {
        showTGNotification("Withdrawal request failed.", "error");
    }
});
profileElements.sellAllButton?.addEventListener('click', sellAllItems);
confirmPaymentSentButton?.addEventListener('click', verifyPaymentSent);
cancelDepositButton?.addEventListener('click', closeDepositInstructionsModal);
async function fetchInitialUserData() {
    if (!Telegram.WebApp.initData) {
        dataFetchedSuccessfully = true;
        return false;
    }
    try {
        const data = await apiRequest('/api/get_user_data', 'POST', {});
        Object.assign(currentUser, data);
        currentUser.first_name = data.first_name || currentUser.first_name || 'User';
        dataFetchedSuccessfully = true;
        return true;
    } catch (e) {
        showTGNotification("Could not load profile.", 'error');
        dataFetchedSuccessfully = false;
        return false;
    }
}
async function initializeApp() {
    updateLoadingStatus("Initializing application...");
    const allImageUrls = new Set();
    casesData.forEach(c => {
        const mainImgSrc = c.imageFilename || (c.name ? generateImageFilename(c.name) : null); if (mainImgSrc) allImageUrls.add(mainImgSrc);
        if (c.overlayPrizeName) allImageUrls.add(generateImageFilename(c.overlayPrizeName));
        c.prizes.forEach(p => { if (p.is_ton_prize) allImageUrls.add(TON_COIN_FULL_URL); else allImageUrls.add(generateImageFilename(p.imageFilename || p.name)); });
    });
    allImageUrls.add(TON_COIN_FULL_URL);
    allImageUrls.forEach(url => { const img = new Image(); img.src = url; });
    if (Telegram.WebApp.BackButton) tgBackButton = Telegram.WebApp.BackButton;
    if (Telegram.WebApp && Telegram.WebApp.initDataUnsafe) {
        updateLoadingStatus("Connecting to Telegram Mini App...");
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.enableClosingConfirmation();
        const tgUser = Telegram.WebApp.initDataUnsafe.user;
        if (tgUser) {
            currentUser.id = tgUser.id;
            currentUser.username = tgUser.username;
            currentUser.first_name = tgUser.first_name || 'User';
            currentUser.last_name = tgUser.last_name;
            currentUser.photo_url = tgUser.photo_url || null;
            if (!currentUser.referralCode) currentUser.referralCode = `ref_${currentUser.id.toString().slice(-6)}`;
        }
        populateAllAppGifts();
        try {
            const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg-gradient-start').trim() || '#181A25';
            Telegram.WebApp.setHeaderColor(bg);
            Telegram.WebApp.setBackgroundColor(bg);
        } catch (e) {
            console.warn("Failed to set Telegram WebApp colors:", e);
        }
    } else {
        console.warn("Not running inside Telegram WebApp. Using fallback data.");
        if (!currentUser.referralCode) currentUser.referralCode = `ref_BRWSR${Math.random().toString(36).substring(2, 8)}`;
        currentUser.photo_url = 'https://i.ibb.co/N6dt5Pc9/Background-Eraser-20250423-210102862.png'; 
    }
    updateLoadingStatus("Authenticating wallet...");
    tonConnectUI.onStatusChange(async wallet => {
        updateUIBasedOnWallet(wallet); 
        if (dataFetchedSuccessfully) {
            renderHeader();
            renderProfile();
        }
    });
    updateLoadingStatus("Loading user data...");
    if (Telegram.WebApp.initData) {
        await fetchInitialUserData();
    } else {
        dataFetchedSuccessfully = true;
    }
    updateUIBasedOnWallet(tonConnectWalletInfo || tonConnectUI.wallet);
    updateLoadingStatus("Loading game content...");
    renderHeader();
    renderBanners();
    renderCasesAndSlots();
    renderProfile();
    renderLeaderboard();
    renderInvitePage();
    navigateToPage('main-page');
    updateLoadingStatus("Ready!");
    if (loadingScreen) {
        loadingScreen.classList.add('hidden');
    }
}
document.addEventListener('DOMContentLoaded', initializeApp);
document.addEventListener('DOMContentLoaded', calculateAndDisplayUpgradeStats);
</script>
</body>
    </html>
